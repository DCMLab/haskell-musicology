<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE DeriveGeneric #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-10"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Musicology.IO.MidiFile</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Musicology.Core</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Pitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Musicology.Internal.Helpers.html"><span class="hs-identifier">Musicology.Internal.Helpers</span></a></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Codec.Midi</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">channel</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Channel</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Velocity</span></span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">catMaybes</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">listToMaybe</span></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Ratio</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.HashMap.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">mapAccumL</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">sortOn</span></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Ord</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">comparing</span></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Frames</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-operator">:&amp;</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Frames.InCore</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">VectorFor</span></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Frames.TH</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">declareColumn</span></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Vinyl.Core</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Rec</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Vector</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">V</span></span><span>
</span><span id="line-27"></span><span class="hs-comment">-- import Pipes</span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">GHC.Generics</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.DeepSeq</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NFData</span></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.FilePath</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">takeExtension</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">takeBaseName</span></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.Directory</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">listDirectory</span></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="hs-comment">-- import qualified Data.Machine as MC</span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span id="local-6989586621679130487"><span id="local-6989586621679130488"></span></span><span class="hs-keyword">data</span><span> </span><span id="MidiNote"><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiNote"><span class="hs-identifier hs-var">MidiNote</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="MidiNote"><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiNote"><span class="hs-identifier hs-var">MidiNote</span></a></span></span><span>
</span><span id="line-38"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_onsetTicks"><span class="annot"><span class="annottext">MidiNote -&gt; Int
</span><a href="Musicology.IO.MidiFile.html#_onsetTicks"><span class="hs-identifier hs-var hs-var">_onsetTicks</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-39"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_offsetTicks"><span class="annot"><span class="annottext">MidiNote -&gt; Int
</span><a href="Musicology.IO.MidiFile.html#_offsetTicks"><span class="hs-identifier hs-var hs-var">_offsetTicks</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-40"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_onsetWholes"><span class="annot"><span class="annottext">MidiNote -&gt; Ratio Int
</span><a href="Musicology.IO.MidiFile.html#_onsetWholes"><span class="hs-identifier hs-var hs-var">_onsetWholes</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ratio</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_offsetWholes"><span class="annot"><span class="annottext">MidiNote -&gt; Ratio Int
</span><a href="Musicology.IO.MidiFile.html#_offsetWholes"><span class="hs-identifier hs-var hs-var">_offsetWholes</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ratio</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_onsetSecs"><span class="annot"><span class="annottext">MidiNote -&gt; Double
</span><a href="Musicology.IO.MidiFile.html#_onsetSecs"><span class="hs-identifier hs-var hs-var">_onsetSecs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span>
</span><span id="line-43"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_offsetSecs"><span class="annot"><span class="annottext">MidiNote -&gt; Double
</span><a href="Musicology.IO.MidiFile.html#_offsetSecs"><span class="hs-identifier hs-var hs-var">_offsetSecs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span>
</span><span id="line-44"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_pitch"><span class="annot"><span class="annottext">MidiNote -&gt; MidiPitch
</span><a href="Musicology.IO.MidiFile.html#_pitch"><span class="hs-identifier hs-var hs-var">_pitch</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MidiPitch</span></span><span>
</span><span id="line-45"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_velocity"><span class="annot"><span class="annottext">MidiNote -&gt; Int
</span><a href="Musicology.IO.MidiFile.html#_velocity"><span class="hs-identifier hs-var hs-var">_velocity</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-46"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_trackNum"><span class="annot"><span class="annottext">MidiNote -&gt; Int
</span><a href="Musicology.IO.MidiFile.html#_trackNum"><span class="hs-identifier hs-var hs-var">_trackNum</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-47"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_channel"><span class="annot"><span class="annottext">MidiNote -&gt; Int
</span><a href="Musicology.IO.MidiFile.html#_channel"><span class="hs-identifier hs-var hs-var">_channel</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-48"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_keySharps"><span class="annot"><span class="annottext">MidiNote -&gt; Int
</span><a href="Musicology.IO.MidiFile.html#_keySharps"><span class="hs-identifier hs-var hs-var">_keySharps</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-49"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_keyMajor"><span class="annot"><span class="annottext">MidiNote -&gt; Bool
</span><a href="Musicology.IO.MidiFile.html#_keyMajor"><span class="hs-identifier hs-var hs-var">_keyMajor</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-50"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_bar"><span class="annot"><span class="annottext">MidiNote -&gt; Int
</span><a href="Musicology.IO.MidiFile.html#_bar"><span class="hs-identifier hs-var hs-var">_bar</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-51"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_beat"><span class="annot"><span class="annottext">MidiNote -&gt; Int
</span><a href="Musicology.IO.MidiFile.html#_beat"><span class="hs-identifier hs-var hs-var">_beat</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-52"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_subbeat"><span class="annot"><span class="annottext">MidiNote -&gt; Ratio Int
</span><a href="Musicology.IO.MidiFile.html#_subbeat"><span class="hs-identifier hs-var hs-var">_subbeat</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ratio</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-53"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679130467"><span id="local-6989586621679130469"><span class="annot"><span class="annottext">MidiNote -&gt; MidiNote -&gt; Bool
(MidiNote -&gt; MidiNote -&gt; Bool)
-&gt; (MidiNote -&gt; MidiNote -&gt; Bool) -&gt; Eq MidiNote
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: MidiNote -&gt; MidiNote -&gt; Bool
$c/= :: MidiNote -&gt; MidiNote -&gt; Bool
== :: MidiNote -&gt; MidiNote -&gt; Bool
$c== :: MidiNote -&gt; MidiNote -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679130460"><span id="local-6989586621679130462"><span id="local-6989586621679130464"><span class="annot"><span class="annottext">Int -&gt; MidiNote -&gt; ShowS
[MidiNote] -&gt; ShowS
MidiNote -&gt; String
(Int -&gt; MidiNote -&gt; ShowS)
-&gt; (MidiNote -&gt; String) -&gt; ([MidiNote] -&gt; ShowS) -&gt; Show MidiNote
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [MidiNote] -&gt; ShowS
$cshowList :: [MidiNote] -&gt; ShowS
show :: MidiNote -&gt; String
$cshow :: MidiNote -&gt; String
showsPrec :: Int -&gt; MidiNote -&gt; ShowS
$cshowsPrec :: Int -&gt; MidiNote -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. MidiNote -&gt; Rep MidiNote x)
-&gt; (forall x. Rep MidiNote x -&gt; MidiNote) -&gt; Generic MidiNote
forall x. Rep MidiNote x -&gt; MidiNote
forall x. MidiNote -&gt; Rep MidiNote x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep MidiNote x -&gt; MidiNote
$cfrom :: forall x. MidiNote -&gt; Rep MidiNote x
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span class="annot"><a href="Musicology.IO.MidiFile.html#asTicks"><span class="hs-identifier hs-type">asTicks</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiNote"><span class="hs-identifier hs-type">MidiNote</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Note</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">MidiInterval</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-57"></span><span id="asTicks"><span class="annot"><span class="annottext">asTicks :: MidiNote -&gt; Note Int Int
</span><a href="Musicology.IO.MidiFile.html#asTicks"><span class="hs-identifier hs-var hs-var">asTicks</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiNote"><span class="hs-identifier hs-type">MidiNote</span></a></span><span> </span><span id="local-6989586621679130453"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130453"><span class="hs-identifier hs-var">on</span></a></span></span><span> </span><span id="local-6989586621679130452"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130452"><span class="hs-identifier hs-var">off</span></a></span></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679130451"><span class="annot"><span class="annottext">MidiPitch
</span><a href="#local-6989586621679130451"><span class="hs-identifier hs-var">pitch</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MidiPitch -&gt; Int -&gt; Int -&gt; Note Int Int
forall p t. Pitch p -&gt; t -&gt; t -&gt; Note p t
</span><span class="hs-identifier hs-var">Note</span></span><span> </span><span class="annot"><span class="annottext">MidiPitch
</span><a href="#local-6989586621679130451"><span class="hs-identifier hs-var">pitch</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130453"><span class="hs-identifier hs-var">on</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130452"><span class="hs-identifier hs-var">off</span></a></span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span class="annot"><a href="Musicology.IO.MidiFile.html#asWholes"><span class="hs-identifier hs-type">asWholes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiNote"><span class="hs-identifier hs-type">MidiNote</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Note</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">MidiInterval</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ratio</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span id="asWholes"><span class="annot"><span class="annottext">asWholes :: MidiNote -&gt; Note Int (Ratio Int)
</span><a href="Musicology.IO.MidiFile.html#asWholes"><span class="hs-identifier hs-var hs-var">asWholes</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiNote"><span class="hs-identifier hs-type">MidiNote</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679130448"><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130448"><span class="hs-identifier hs-var">on</span></a></span></span><span> </span><span id="local-6989586621679130447"><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130447"><span class="hs-identifier hs-var">off</span></a></span></span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679130446"><span class="annot"><span class="annottext">MidiPitch
</span><a href="#local-6989586621679130446"><span class="hs-identifier hs-var">pitch</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MidiPitch -&gt; Ratio Int -&gt; Ratio Int -&gt; Note Int (Ratio Int)
forall p t. Pitch p -&gt; t -&gt; t -&gt; Note p t
</span><span class="hs-identifier hs-var">Note</span></span><span> </span><span class="annot"><span class="annottext">MidiPitch
</span><a href="#local-6989586621679130446"><span class="hs-identifier hs-var">pitch</span></a></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130448"><span class="hs-identifier hs-var">on</span></a></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130447"><span class="hs-identifier hs-var">off</span></a></span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="annot"><a href="Musicology.IO.MidiFile.html#asSecs"><span class="hs-identifier hs-type">asSecs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiNote"><span class="hs-identifier hs-type">MidiNote</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Note</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">MidiInterval</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span>
</span><span id="line-63"></span><span id="asSecs"><span class="annot"><span class="annottext">asSecs :: MidiNote -&gt; Note Int Double
</span><a href="Musicology.IO.MidiFile.html#asSecs"><span class="hs-identifier hs-var hs-var">asSecs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiNote"><span class="hs-identifier hs-type">MidiNote</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679130444"><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679130444"><span class="hs-identifier hs-var">on</span></a></span></span><span> </span><span id="local-6989586621679130443"><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679130443"><span class="hs-identifier hs-var">off</span></a></span></span><span> </span><span id="local-6989586621679130442"><span class="annot"><span class="annottext">MidiPitch
</span><a href="#local-6989586621679130442"><span class="hs-identifier hs-var">pitch</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MidiPitch -&gt; Double -&gt; Double -&gt; Note Int Double
forall p t. Pitch p -&gt; t -&gt; t -&gt; Note p t
</span><span class="hs-identifier hs-var">Note</span></span><span> </span><span class="annot"><span class="annottext">MidiPitch
</span><a href="#local-6989586621679130442"><span class="hs-identifier hs-var">pitch</span></a></span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679130444"><span class="hs-identifier hs-var">on</span></a></span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679130443"><span class="hs-identifier hs-var">off</span></a></span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621679130440"><span class="annot"><span class="hs-identifier hs-type">NFData</span></span><span> </span><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiNote"><span class="hs-identifier hs-type">MidiNote</span></a></span></span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">instance</span><span> </span><span id="VectorFor"><span class="annot"><span class="hs-identifier hs-var">VectorFor</span></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ratio</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">V.Vector</span></span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span class="hs-keyword">type</span><span> </span><span id="MidiRecord"><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiRecord"><span class="hs-identifier hs-var">MidiRecord</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Record</span></span><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span> </span><span class="annot"><span class="hs-string">&quot;onsetTicks&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:-&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;offsetTicks&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:-&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-70"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;onsetWholes&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:-&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ratio</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;offsetWholes&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:-&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ratio</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-71"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;onsetSecs&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:-&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;offsetSecs&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:-&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span>
</span><span id="line-72"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;pitch&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:-&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;velocity&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:-&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;trackNum&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:-&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-73"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;channel&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:-&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;keySharps&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:-&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;keyMajor&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:-&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-74"></span><span>                          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;bar&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:-&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;beat&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:-&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;subbeat&quot;</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:-&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ratio</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-75"></span><span>                          </span><span class="hs-special">]</span><span>
</span><span id="line-76"></span><span class="hs-keyword">type</span><span> </span><span id="RatioInt"><span class="annot"><a href="Musicology.IO.MidiFile.html#RatioInt"><span class="hs-identifier hs-var">RatioInt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ratio</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span id="onsetTicks%27"><span id="onsetTicks"><span id="local-6989586621679130432"><span id="local-6989586621679130433"><span id="local-6989586621679130434"><span id="local-6989586621679130435"><span id="local-6989586621679130436"><span id="OnsetTicks"><span class="hs-identifier">declareColumn</span><span> </span><span class="hs-string">&quot;onsetTicks&quot;</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Int</span></span></span></span></span></span></span></span></span><span>
</span><span id="line-79"></span><span id="offsetTicks%27"><span id="offsetTicks"><span id="local-6989586621679130425"><span id="local-6989586621679130426"><span id="local-6989586621679130427"><span id="local-6989586621679130428"><span id="local-6989586621679130429"><span id="OffsetTicks"><span class="hs-identifier">declareColumn</span><span> </span><span class="hs-string">&quot;offsetTicks&quot;</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Int</span></span></span></span></span></span></span></span></span><span>
</span><span id="line-80"></span><span id="onsetWholes%27"><span id="onsetWholes"><span id="local-6989586621679130418"><span id="local-6989586621679130419"><span id="local-6989586621679130420"><span id="local-6989586621679130421"><span id="local-6989586621679130422"><span id="OnsetWholes"><span class="hs-identifier">declareColumn</span><span> </span><span class="hs-string">&quot;onsetWholes&quot;</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">RatioInt</span></span></span></span></span></span></span></span></span><span>
</span><span id="line-81"></span><span id="offsetWholes%27"><span id="offsetWholes"><span id="local-6989586621679130411"><span id="local-6989586621679130412"><span id="local-6989586621679130413"><span id="local-6989586621679130414"><span id="local-6989586621679130415"><span id="OffsetWholes"><span class="hs-identifier">declareColumn</span><span> </span><span class="hs-string">&quot;offsetWholes&quot;</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">RatioInt</span></span></span></span></span></span></span></span></span><span>
</span><span id="line-82"></span><span id="onsetSecs%27"><span id="onsetSecs"><span id="local-6989586621679130404"><span id="local-6989586621679130405"><span id="local-6989586621679130406"><span id="local-6989586621679130407"><span id="local-6989586621679130408"><span id="OnsetSecs"><span class="hs-identifier">declareColumn</span><span> </span><span class="hs-string">&quot;onsetSecs&quot;</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Int</span></span></span></span></span></span></span></span></span><span>
</span><span id="line-83"></span><span id="offsetSecs%27"><span id="offsetSecs"><span id="local-6989586621679130397"><span id="local-6989586621679130398"><span id="local-6989586621679130399"><span id="local-6989586621679130400"><span id="local-6989586621679130401"><span id="OffsetSecs"><span class="hs-identifier">declareColumn</span><span> </span><span class="hs-string">&quot;offsetSecs&quot;</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Int</span></span></span></span></span></span></span></span></span><span>
</span><span id="line-84"></span><span id="pitch%27"><span id="pitch"><span id="local-6989586621679130390"><span id="local-6989586621679130391"><span id="local-6989586621679130392"><span id="local-6989586621679130393"><span id="local-6989586621679130394"><span id="Pitch"><span class="hs-identifier">declareColumn</span><span> </span><span class="hs-string">&quot;pitch&quot;</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Int</span></span></span></span></span></span></span></span></span><span>
</span><span id="line-85"></span><span id="velocity%27"><span id="velocity"><span id="local-6989586621679130383"><span id="local-6989586621679130384"><span id="local-6989586621679130385"><span id="local-6989586621679130386"><span id="local-6989586621679130387"><span id="Velocity"><span class="hs-identifier">declareColumn</span><span> </span><span class="hs-string">&quot;velocity&quot;</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Int</span></span></span></span></span></span></span></span></span><span>
</span><span id="line-86"></span><span id="trackNum%27"><span id="trackNum"><span id="local-6989586621679130376"><span id="local-6989586621679130377"><span id="local-6989586621679130378"><span id="local-6989586621679130379"><span id="local-6989586621679130380"><span id="TrackNum"><span class="hs-identifier">declareColumn</span><span> </span><span class="hs-string">&quot;trackNum&quot;</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Int</span></span></span></span></span></span></span></span></span><span>
</span><span id="line-87"></span><span id="channel%27"><span id="channel"><span id="local-6989586621679130369"><span id="local-6989586621679130370"><span id="local-6989586621679130371"><span id="local-6989586621679130372"><span id="local-6989586621679130373"><span id="Channel"><span class="hs-identifier">declareColumn</span><span> </span><span class="hs-string">&quot;channel&quot;</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Int</span></span></span></span></span></span></span></span></span><span>
</span><span id="line-88"></span><span id="keySharps%27"><span id="keySharps"><span id="local-6989586621679130362"><span id="local-6989586621679130363"><span id="local-6989586621679130364"><span id="local-6989586621679130365"><span id="local-6989586621679130366"><span id="KeySharps"><span class="hs-identifier">declareColumn</span><span> </span><span class="hs-string">&quot;keySharps&quot;</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Int</span></span></span></span></span></span></span></span></span><span>
</span><span id="line-89"></span><span id="keyMajor%27"><span id="keyMajor"><span id="local-6989586621679130355"><span id="local-6989586621679130356"><span id="local-6989586621679130357"><span id="local-6989586621679130358"><span id="local-6989586621679130359"><span id="KeyMajor"><span class="hs-identifier">declareColumn</span><span> </span><span class="hs-string">&quot;keyMajor&quot;</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Bool</span></span></span></span></span></span></span></span></span><span>
</span><span id="line-90"></span><span id="bar%27"><span id="bar"><span id="local-6989586621679130348"><span id="local-6989586621679130349"><span id="local-6989586621679130350"><span id="local-6989586621679130351"><span id="local-6989586621679130352"><span id="Bar"><span class="hs-identifier">declareColumn</span><span> </span><span class="hs-string">&quot;bar&quot;</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Int</span></span></span></span></span></span></span></span></span><span>
</span><span id="line-91"></span><span id="beat%27"><span id="beat"><span id="local-6989586621679130341"><span id="local-6989586621679130342"><span id="local-6989586621679130343"><span id="local-6989586621679130344"><span id="local-6989586621679130345"><span id="Beat"><span class="hs-identifier">declareColumn</span><span> </span><span class="hs-string">&quot;beat&quot;</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Int</span></span></span></span></span></span></span></span></span><span>
</span><span id="line-92"></span><span id="subbeat%27"><span id="subbeat"><span id="local-6989586621679130334"><span id="local-6989586621679130335"><span id="local-6989586621679130336"><span id="local-6989586621679130337"><span id="local-6989586621679130338"><span id="Subbeat"><span class="hs-identifier">declareColumn</span><span> </span><span class="hs-string">&quot;subbeat&quot;</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">RatioInt</span></span></span></span></span></span></span></span></span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span class="annot"><a href="Musicology.IO.MidiFile.html#midiNoteToRecord"><span class="hs-identifier hs-type">midiNoteToRecord</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiNote"><span class="hs-identifier hs-type">MidiNote</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiRecord"><span class="hs-identifier hs-type">MidiRecord</span></a></span><span>
</span><span id="line-95"></span><span id="midiNoteToRecord"><span class="annot"><span class="annottext">midiNoteToRecord :: MidiNote -&gt; MidiRecord
</span><a href="Musicology.IO.MidiFile.html#midiNoteToRecord"><span class="hs-identifier hs-var hs-var">midiNoteToRecord</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiNote"><span class="hs-identifier hs-type">MidiNote</span></a></span><span> </span><span id="local-6989586621679130330"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130330"><span class="hs-identifier hs-var">ont</span></a></span></span><span> </span><span id="local-6989586621679130329"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130329"><span class="hs-identifier hs-var">oft</span></a></span></span><span> </span><span id="local-6989586621679130328"><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130328"><span class="hs-identifier hs-var">onw</span></a></span></span><span> </span><span id="local-6989586621679130327"><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130327"><span class="hs-identifier hs-var">ofw</span></a></span></span><span> </span><span id="local-6989586621679130326"><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679130326"><span class="hs-identifier hs-var">ons</span></a></span></span><span> </span><span id="local-6989586621679130325"><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679130325"><span class="hs-identifier hs-var">ofs</span></a></span></span><span> </span><span id="local-6989586621679130324"><span class="annot"><span class="annottext">MidiPitch
</span><a href="#local-6989586621679130324"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679130323"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130323"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621679130322"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130322"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621679130321"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130321"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621679130320"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130320"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679130319"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679130319"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621679130318"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130318"><span class="hs-identifier hs-var">bar</span></a></span></span><span> </span><span id="local-6989586621679130317"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130317"><span class="hs-identifier hs-var">beat</span></a></span></span><span> </span><span id="local-6989586621679130316"><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130316"><span class="hs-identifier hs-var">sub</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-96"></span><span>  </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130330"><span class="hs-identifier hs-var">ont</span></a></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Record
     '[OffsetTicks, OnsetWholes, OffsetWholes, &quot;onsetSecs&quot; :-&gt; Double,
       &quot;offsetSecs&quot; :-&gt; Double, Pitch, Velocity, TrackNum, Channel,
       KeySharps, KeyMajor, Bar, Beat, Subbeat]
-&gt; MidiRecord
forall (s :: Symbol) a (rs :: [(Symbol, *)]).
KnownSymbol s =&gt;
a -&gt; Record rs -&gt; Record ((s :-&gt; a) : rs)
</span><span class="hs-operator hs-var">&amp;:</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130329"><span class="hs-identifier hs-var">oft</span></a></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Record
     '[OnsetWholes, OffsetWholes, &quot;onsetSecs&quot; :-&gt; Double,
       &quot;offsetSecs&quot; :-&gt; Double, Pitch, Velocity, TrackNum, Channel,
       KeySharps, KeyMajor, Bar, Beat, Subbeat]
-&gt; Record
     '[OffsetTicks, OnsetWholes, OffsetWholes, &quot;onsetSecs&quot; :-&gt; Double,
       &quot;offsetSecs&quot; :-&gt; Double, Pitch, Velocity, TrackNum, Channel,
       KeySharps, KeyMajor, Bar, Beat, Subbeat]
forall (s :: Symbol) a (rs :: [(Symbol, *)]).
KnownSymbol s =&gt;
a -&gt; Record rs -&gt; Record ((s :-&gt; a) : rs)
</span><span class="hs-operator hs-var">&amp;:</span></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130328"><span class="hs-identifier hs-var">onw</span></a></span><span> </span><span class="annot"><span class="annottext">Ratio Int
-&gt; Record
     '[OffsetWholes, &quot;onsetSecs&quot; :-&gt; Double, &quot;offsetSecs&quot; :-&gt; Double,
       Pitch, Velocity, TrackNum, Channel, KeySharps, KeyMajor, Bar, Beat,
       Subbeat]
-&gt; Record
     '[OnsetWholes, OffsetWholes, &quot;onsetSecs&quot; :-&gt; Double,
       &quot;offsetSecs&quot; :-&gt; Double, Pitch, Velocity, TrackNum, Channel,
       KeySharps, KeyMajor, Bar, Beat, Subbeat]
forall (s :: Symbol) a (rs :: [(Symbol, *)]).
KnownSymbol s =&gt;
a -&gt; Record rs -&gt; Record ((s :-&gt; a) : rs)
</span><span class="hs-operator hs-var">&amp;:</span></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130327"><span class="hs-identifier hs-var">ofw</span></a></span><span> </span><span class="annot"><span class="annottext">Ratio Int
-&gt; Record
     '[&quot;onsetSecs&quot; :-&gt; Double, &quot;offsetSecs&quot; :-&gt; Double, Pitch, Velocity,
       TrackNum, Channel, KeySharps, KeyMajor, Bar, Beat, Subbeat]
-&gt; Record
     '[OffsetWholes, &quot;onsetSecs&quot; :-&gt; Double, &quot;offsetSecs&quot; :-&gt; Double,
       Pitch, Velocity, TrackNum, Channel, KeySharps, KeyMajor, Bar, Beat,
       Subbeat]
forall (s :: Symbol) a (rs :: [(Symbol, *)]).
KnownSymbol s =&gt;
a -&gt; Record rs -&gt; Record ((s :-&gt; a) : rs)
</span><span class="hs-operator hs-var">&amp;:</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679130326"><span class="hs-identifier hs-var">ons</span></a></span><span> </span><span class="annot"><span class="annottext">Double
-&gt; Record
     '[&quot;offsetSecs&quot; :-&gt; Double, Pitch, Velocity, TrackNum, Channel,
       KeySharps, KeyMajor, Bar, Beat, Subbeat]
-&gt; Record
     '[&quot;onsetSecs&quot; :-&gt; Double, &quot;offsetSecs&quot; :-&gt; Double, Pitch, Velocity,
       TrackNum, Channel, KeySharps, KeyMajor, Bar, Beat, Subbeat]
forall (s :: Symbol) a (rs :: [(Symbol, *)]).
KnownSymbol s =&gt;
a -&gt; Record rs -&gt; Record ((s :-&gt; a) : rs)
</span><span class="hs-operator hs-var">&amp;:</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679130325"><span class="hs-identifier hs-var">ofs</span></a></span><span> </span><span class="annot"><span class="annottext">Double
-&gt; Record
     '[Pitch, Velocity, TrackNum, Channel, KeySharps, KeyMajor, Bar,
       Beat, Subbeat]
-&gt; Record
     '[&quot;offsetSecs&quot; :-&gt; Double, Pitch, Velocity, TrackNum, Channel,
       KeySharps, KeyMajor, Bar, Beat, Subbeat]
forall (s :: Symbol) a (rs :: [(Symbol, *)]).
KnownSymbol s =&gt;
a -&gt; Record rs -&gt; Record ((s :-&gt; a) : rs)
</span><span class="hs-operator hs-var">&amp;:</span></span><span>
</span><span id="line-97"></span><span>  </span><span class="annot"><span class="annottext">MidiPitch -&gt; Int
forall a. Pitch a -&gt; a
</span><span class="hs-identifier hs-var">toInterval</span></span><span> </span><span class="annot"><span class="annottext">MidiPitch
</span><a href="#local-6989586621679130324"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Record
     '[Velocity, TrackNum, Channel, KeySharps, KeyMajor, Bar, Beat,
       Subbeat]
-&gt; Record
     '[Pitch, Velocity, TrackNum, Channel, KeySharps, KeyMajor, Bar,
       Beat, Subbeat]
forall (s :: Symbol) a (rs :: [(Symbol, *)]).
KnownSymbol s =&gt;
a -&gt; Record rs -&gt; Record ((s :-&gt; a) : rs)
</span><span class="hs-operator hs-var">&amp;:</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130323"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Record
     '[TrackNum, Channel, KeySharps, KeyMajor, Bar, Beat, Subbeat]
-&gt; Record
     '[Velocity, TrackNum, Channel, KeySharps, KeyMajor, Bar, Beat,
       Subbeat]
forall (s :: Symbol) a (rs :: [(Symbol, *)]).
KnownSymbol s =&gt;
a -&gt; Record rs -&gt; Record ((s :-&gt; a) : rs)
</span><span class="hs-operator hs-var">&amp;:</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130322"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Record '[Channel, KeySharps, KeyMajor, Bar, Beat, Subbeat]
-&gt; Record
     '[TrackNum, Channel, KeySharps, KeyMajor, Bar, Beat, Subbeat]
forall (s :: Symbol) a (rs :: [(Symbol, *)]).
KnownSymbol s =&gt;
a -&gt; Record rs -&gt; Record ((s :-&gt; a) : rs)
</span><span class="hs-operator hs-var">&amp;:</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130321"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Record '[KeySharps, KeyMajor, Bar, Beat, Subbeat]
-&gt; Record '[Channel, KeySharps, KeyMajor, Bar, Beat, Subbeat]
forall (s :: Symbol) a (rs :: [(Symbol, *)]).
KnownSymbol s =&gt;
a -&gt; Record rs -&gt; Record ((s :-&gt; a) : rs)
</span><span class="hs-operator hs-var">&amp;:</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130320"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Record '[KeyMajor, Bar, Beat, Subbeat]
-&gt; Record '[KeySharps, KeyMajor, Bar, Beat, Subbeat]
forall (s :: Symbol) a (rs :: [(Symbol, *)]).
KnownSymbol s =&gt;
a -&gt; Record rs -&gt; Record ((s :-&gt; a) : rs)
</span><span class="hs-operator hs-var">&amp;:</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679130319"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
-&gt; Record '[Bar, Beat, Subbeat]
-&gt; Record '[KeyMajor, Bar, Beat, Subbeat]
forall (s :: Symbol) a (rs :: [(Symbol, *)]).
KnownSymbol s =&gt;
a -&gt; Record rs -&gt; Record ((s :-&gt; a) : rs)
</span><span class="hs-operator hs-var">&amp;:</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130318"><span class="hs-identifier hs-var">bar</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Record '[Beat, Subbeat] -&gt; Record '[Bar, Beat, Subbeat]
forall (s :: Symbol) a (rs :: [(Symbol, *)]).
KnownSymbol s =&gt;
a -&gt; Record rs -&gt; Record ((s :-&gt; a) : rs)
</span><span class="hs-operator hs-var">&amp;:</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130317"><span class="hs-identifier hs-var">beat</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Record '[Subbeat] -&gt; Record '[Beat, Subbeat]
forall (s :: Symbol) a (rs :: [(Symbol, *)]).
KnownSymbol s =&gt;
a -&gt; Record rs -&gt; Record ((s :-&gt; a) : rs)
</span><span class="hs-operator hs-var">&amp;:</span></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130316"><span class="hs-identifier hs-var">sub</span></a></span><span> </span><span class="annot"><span class="annottext">Ratio Int -&gt; Record '[] -&gt; Record '[Subbeat]
forall (s :: Symbol) a (rs :: [(Symbol, *)]).
KnownSymbol s =&gt;
a -&gt; Record rs -&gt; Record ((s :-&gt; a) : rs)
</span><span class="hs-operator hs-var">&amp;:</span></span><span> </span><span class="annot"><span class="annottext">Record '[]
forall u (a :: u -&gt; *). Rec a '[]
</span><span class="hs-identifier hs-var">RNil</span></span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span class="annot"><a href="Musicology.IO.MidiFile.html#printNote"><span class="hs-identifier hs-type">printNote</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiNote"><span class="hs-identifier hs-type">MidiNote</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span id="printNote"><span class="annot"><span class="annottext">printNote :: MidiNote -&gt; IO ()
</span><a href="Musicology.IO.MidiFile.html#printNote"><span class="hs-identifier hs-var hs-var">printNote</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiNote"><span class="hs-identifier hs-type">MidiNote</span></a></span><span> </span><span id="local-6989586621679130311"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130311"><span class="hs-identifier hs-var">ont</span></a></span></span><span> </span><span id="local-6989586621679130310"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130310"><span class="hs-identifier hs-var">offt</span></a></span></span><span> </span><span id="local-6989586621679130309"><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130309"><span class="hs-identifier hs-var">onw</span></a></span></span><span> </span><span id="local-6989586621679130308"><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130308"><span class="hs-identifier hs-var">offw</span></a></span></span><span> </span><span id="local-6989586621679130307"><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679130307"><span class="hs-identifier hs-var">ons</span></a></span></span><span> </span><span id="local-6989586621679130306"><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679130306"><span class="hs-identifier hs-var">offs</span></a></span></span><span> </span><span id="local-6989586621679130305"><span class="annot"><span class="annottext">MidiPitch
</span><a href="#local-6989586621679130305"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679130304"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130304"><span class="hs-identifier hs-var">vel</span></a></span></span><span> </span><span id="local-6989586621679130303"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130303"><span class="hs-identifier hs-var">id</span></a></span></span><span> </span><span id="local-6989586621679130302"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130302"><span class="hs-identifier hs-var">ch</span></a></span></span><span> </span><span id="local-6989586621679130301"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130301"><span class="hs-identifier hs-var">sh</span></a></span></span><span> </span><span id="local-6989586621679130300"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679130300"><span class="hs-identifier hs-var">maj</span></a></span></span><span> </span><span id="local-6989586621679130299"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130299"><span class="hs-identifier hs-var">bar</span></a></span></span><span> </span><span id="local-6989586621679130298"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130298"><span class="hs-identifier hs-var">beat</span></a></span></span><span> </span><span id="local-6989586621679130297"><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130297"><span class="hs-identifier hs-var">subb</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-101"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><span class="hs-identifier hs-var">putStrLn</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; IO ()) -&gt; String -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130311"><span class="hs-identifier hs-var">ont</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\t&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130310"><span class="hs-identifier hs-var">offt</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\t&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-102"></span><span>  </span><span class="annot"><span class="annottext">Ratio Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130309"><span class="hs-identifier hs-var">onw</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\t&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Ratio Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130308"><span class="hs-identifier hs-var">offw</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\t&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-103"></span><span>  </span><span class="annot"><span class="annottext">Double -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679130307"><span class="hs-identifier hs-var">ons</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\t&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Double -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679130306"><span class="hs-identifier hs-var">offs</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\t&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-104"></span><span>  </span><span class="annot"><span class="annottext">MidiPitch -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">MidiPitch
</span><a href="#local-6989586621679130305"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\t&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130304"><span class="hs-identifier hs-var">vel</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\t&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130303"><span class="hs-identifier hs-var">id</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\t&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span>
</span><span id="line-105"></span><span class="hs-comment">--  show ch ++ &quot;\t&quot; ++ show sh ++ &quot;\t&quot; ++ show maj ++ &quot;\t&quot; ++</span><span>
</span><span id="line-106"></span><span>  </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130299"><span class="hs-identifier hs-var">bar</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\t&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130298"><span class="hs-identifier hs-var">beat</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\t&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Ratio Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130297"><span class="hs-identifier hs-var">subb</span></a></span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span class="hs-keyword">type</span><span> </span><span id="PrepEv"><span class="annot"><a href="Musicology.IO.MidiFile.html#PrepEv"><span class="hs-identifier hs-var">PrepEv</span></a></span></span><span> </span><span id="local-6989586621679130294"><span class="annot"><a href="#local-6989586621679130294"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Message</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679130294"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Message</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span id="local-6989586621679130574"><span class="annot"><a href="Musicology.IO.MidiFile.html#prepareTrack"><span class="hs-identifier hs-type">prepareTrack</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Track</span></span><span> </span><span class="annot"><a href="#local-6989586621679130574"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Musicology.IO.MidiFile.html#PrepEv"><span class="hs-identifier hs-type">PrepEv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679130574"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-111"></span><span id="prepareTrack"><span class="annot"><span class="annottext">prepareTrack :: Track a -&gt; Int -&gt; [PrepEv a]
</span><a href="Musicology.IO.MidiFile.html#prepareTrack"><span class="hs-identifier hs-var hs-var">prepareTrack</span></a></span></span><span> </span><span id="local-6989586621679130292"><span class="annot"><span class="annottext">Track a
</span><a href="#local-6989586621679130292"><span class="hs-identifier hs-var">trk</span></a></span></span><span> </span><span id="local-6989586621679130291"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130291"><span class="hs-identifier hs-var">trkNum</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Maybe (PrepEv a)] -&gt; [PrepEv a]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">([Maybe (PrepEv a)] -&gt; [PrepEv a])
-&gt; [Maybe (PrepEv a)] -&gt; [PrepEv a]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Message, [Maybe (PrepEv a)]) -&gt; [Maybe (PrepEv a)]
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((Message, [Maybe (PrepEv a)]) -&gt; [Maybe (PrepEv a)])
-&gt; (Message, [Maybe (PrepEv a)]) -&gt; [Maybe (PrepEv a)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Message -&gt; (a, Message) -&gt; (Message, Maybe (PrepEv a)))
-&gt; Message -&gt; Track a -&gt; (Message, [Maybe (PrepEv a)])
forall (t :: * -&gt; *) a b c.
Traversable t =&gt;
(a -&gt; b -&gt; (a, c)) -&gt; a -&gt; t b -&gt; (a, t c)
</span><span class="hs-identifier hs-var">mapAccumL</span></span><span> </span><span class="annot"><span class="annottext">Message -&gt; (a, Message) -&gt; (Message, Maybe (PrepEv a))
forall a. Message -&gt; (a, Message) -&gt; (Message, Maybe (PrepEv a))
</span><a href="#local-6989586621679130290"><span class="hs-identifier hs-var">nextEv</span></a></span><span> </span><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679130289"><span class="hs-identifier hs-var">init</span></a></span><span> </span><span class="annot"><span class="annottext">Track a
</span><a href="#local-6989586621679130292"><span class="hs-identifier hs-var">trk</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679130289"><span class="annot"><span class="annottext">init :: Message
</span><a href="#local-6989586621679130289"><span class="hs-identifier hs-var hs-var">init</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Message
</span><span class="hs-identifier hs-var">KeySignature</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-113"></span><span>        </span><span id="local-6989586621679130591"><span class="annot"><a href="#local-6989586621679130290"><span class="hs-identifier hs-type">nextEv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Message</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679130591"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Message</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Message</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Musicology.IO.MidiFile.html#PrepEv"><span class="hs-identifier hs-type">PrepEv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679130591"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-114"></span><span>        </span><span id="local-6989586621679130290"><span class="annot"><span class="annottext">nextEv :: Message -&gt; (a, Message) -&gt; (Message, Maybe (PrepEv a))
</span><a href="#local-6989586621679130290"><span class="hs-identifier hs-var hs-var">nextEv</span></a></span></span><span> </span><span class="annot"><span class="annottext">Message
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679130287"><span class="annot"><span class="annottext">ks :: Message
</span><a href="#local-6989586621679130287"><span class="hs-identifier hs-var">ks</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">KeySignature</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679130287"><span class="hs-identifier hs-var">ks</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (PrepEv a)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span>        </span><span class="annot"><a href="#local-6989586621679130290"><span class="hs-identifier hs-var">nextEv</span></a></span><span> </span><span id="local-6989586621679130286"><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679130286"><span class="hs-identifier hs-var">ks</span></a></span></span><span> </span><span id="local-6989586621679130285"><span class="annot"><span class="annottext">(a, Message)
</span><a href="#local-6989586621679130285"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679130286"><span class="hs-identifier hs-var">ks</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PrepEv a -&gt; Maybe (PrepEv a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130291"><span class="hs-identifier hs-var">trkNum</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679130286"><span class="hs-identifier hs-var">ks</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(a, Message)
</span><a href="#local-6989586621679130285"><span class="hs-identifier hs-var">ev</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span id="local-6989586621679130576"><span class="annot"><a href="Musicology.IO.MidiFile.html#mergeTracks"><span class="hs-identifier hs-type">mergeTracks</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621679130576"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Musicology.IO.MidiFile.html#PrepEv"><span class="hs-identifier hs-type">PrepEv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679130576"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Musicology.IO.MidiFile.html#PrepEv"><span class="hs-identifier hs-type">PrepEv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679130576"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Musicology.IO.MidiFile.html#PrepEv"><span class="hs-identifier hs-type">PrepEv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679130576"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-118"></span><span id="mergeTracks"><span class="annot"><span class="annottext">mergeTracks :: [PrepEv a] -&gt; [PrepEv a] -&gt; [PrepEv a]
</span><a href="Musicology.IO.MidiFile.html#mergeTracks"><span class="hs-identifier hs-var hs-var">mergeTracks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PrepEv a -&gt; PrepEv a -&gt; Ordering)
-&gt; [PrepEv a] -&gt; [PrepEv a] -&gt; [PrepEv a]
forall a. (a -&gt; a -&gt; Ordering) -&gt; [a] -&gt; [a] -&gt; [a]
</span><a href="Musicology.Internal.Helpers.html#mergeBy"><span class="hs-identifier hs-var">mergeBy</span></a></span><span> </span><span class="annot"><span class="annottext">((PrepEv a -&gt; PrepEv a -&gt; Ordering)
 -&gt; [PrepEv a] -&gt; [PrepEv a] -&gt; [PrepEv a])
-&gt; (PrepEv a -&gt; PrepEv a -&gt; Ordering)
-&gt; [PrepEv a]
-&gt; [PrepEv a]
-&gt; [PrepEv a]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PrepEv a -&gt; a) -&gt; PrepEv a -&gt; PrepEv a -&gt; Ordering
forall a b. Ord a =&gt; (b -&gt; a) -&gt; b -&gt; b -&gt; Ordering
</span><span class="hs-identifier hs-var">comparing</span></span><span> </span><span class="annot"><span class="annottext">PrepEv a -&gt; a
forall a b a b. (a, b, (a, b)) -&gt; a
</span><a href="#local-6989586621679130282"><span class="hs-identifier hs-var">getTime</span></a></span><span>
</span><span id="line-119"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679130282"><span class="annot"><span class="annottext">getTime :: (a, b, (a, b)) -&gt; a
</span><a href="#local-6989586621679130282"><span class="hs-identifier hs-var hs-var">getTime</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679130281"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679130281"><span class="hs-identifier hs-var">time</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679130281"><span class="hs-identifier hs-var">time</span></a></span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span class="annot"><a href="Musicology.IO.MidiFile.html#midiEvents"><span class="hs-identifier hs-type">midiEvents</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Midi</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Musicology.IO.MidiFile.html#PrepEv"><span class="hs-identifier hs-type">PrepEv</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ticks</span></span><span class="hs-special">]</span><span>
</span><span id="line-122"></span><span id="midiEvents"><span class="annot"><span class="annottext">midiEvents :: Midi -&gt; [PrepEv Int]
</span><a href="Musicology.IO.MidiFile.html#midiEvents"><span class="hs-identifier hs-var hs-var">midiEvents</span></a></span></span><span> </span><span id="local-6989586621679130278"><span class="annot"><span class="annottext">Midi
</span><a href="#local-6989586621679130278"><span class="hs-identifier hs-var">midi</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([PrepEv Int] -&gt; [PrepEv Int] -&gt; [PrepEv Int])
-&gt; [PrepEv Int] -&gt; [[PrepEv Int]] -&gt; [PrepEv Int]
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">[PrepEv Int] -&gt; [PrepEv Int] -&gt; [PrepEv Int]
forall a. Ord a =&gt; [PrepEv a] -&gt; [PrepEv a] -&gt; [PrepEv a]
</span><a href="Musicology.IO.MidiFile.html#mergeTracks"><span class="hs-identifier hs-var">mergeTracks</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[[PrepEv Int]]
</span><a href="#local-6989586621679130276"><span class="hs-identifier hs-var">prepared</span></a></span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679130275"><span class="annot"><span class="annottext">prep :: Track a -&gt; Int -&gt; [PrepEv a]
</span><a href="#local-6989586621679130275"><span class="hs-identifier hs-var hs-var">prep</span></a></span></span><span> </span><span id="local-6989586621679130274"><span class="annot"><span class="annottext">Track a
</span><a href="#local-6989586621679130274"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Track a -&gt; Int -&gt; [PrepEv a]
forall a. Track a -&gt; Int -&gt; [PrepEv a]
</span><a href="Musicology.IO.MidiFile.html#prepareTrack"><span class="hs-identifier hs-var">prepareTrack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Track a -&gt; Track a
forall a. Num a =&gt; Track a -&gt; Track a
</span><span class="hs-identifier hs-var">toAbsTime</span></span><span> </span><span class="annot"><span class="annottext">Track a
</span><a href="#local-6989586621679130274"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span>        </span><span id="local-6989586621679130276"><span class="annot"><span class="annottext">prepared :: [[PrepEv Int]]
</span><a href="#local-6989586621679130276"><span class="hs-identifier hs-var hs-var">prepared</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Track Int -&gt; Int -&gt; [PrepEv Int])
-&gt; [Track Int] -&gt; [Int] -&gt; [[PrepEv Int]]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">Track Int -&gt; Int -&gt; [PrepEv Int]
forall a. Num a =&gt; Track a -&gt; Int -&gt; [PrepEv a]
</span><a href="#local-6989586621679130275"><span class="hs-identifier hs-var">prep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Midi -&gt; [Track Int]
</span><span class="hs-identifier hs-var hs-var">tracks</span></span><span> </span><span class="annot"><span class="annottext">Midi
</span><a href="#local-6989586621679130278"><span class="hs-identifier hs-var">midi</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span class="hs-comment">-- produceEvents :: Monad m =&gt; Midi -&gt; Producer (PrepEv Ticks) m ()</span><span>
</span><span id="line-127"></span><span class="hs-comment">-- produceEvents = each . midiEvents</span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span class="annot"><a href="Musicology.IO.MidiFile.html#timeRatios"><span class="hs-identifier hs-type">timeRatios</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TimeDiv</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ratio</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span class="hs-special">)</span><span>
</span><span id="line-130"></span><span id="timeRatios"><span class="annot"><span class="annottext">timeRatios :: TimeDiv -&gt; Int -&gt; (Ratio Int, Double)
</span><a href="Musicology.IO.MidiFile.html#timeRatios"><span class="hs-identifier hs-var hs-var">timeRatios</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TicksPerBeat</span></span><span> </span><span id="local-6989586621679130268"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130268"><span class="hs-identifier hs-var">ppq</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679130267"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130267"><span class="hs-identifier hs-var">mspq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-131"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Ratio Int
forall a. Integral a =&gt; a -&gt; a -&gt; Ratio a
</span><span class="hs-operator hs-var">%</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130268"><span class="hs-identifier hs-var">ppq</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Double
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130267"><span class="hs-identifier hs-var">mspq</span></a></span><span> </span><span class="annot"><span class="annottext">Double -&gt; Double -&gt; Double
forall a. Fractional a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">/</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">1000000.0</span></span><span> </span><span class="annot"><span class="annottext">Double -&gt; Double -&gt; Double
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Double
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130268"><span class="hs-identifier hs-var">ppq</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span class="annot"><a href="Musicology.IO.MidiFile.html#timeRatios"><span class="hs-identifier hs-var">timeRatios</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TicksPerSecond</span></span><span> </span><span id="local-6989586621679130262"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130262"><span class="hs-identifier hs-var">tpf</span></a></span></span><span> </span><span id="local-6989586621679130261"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130261"><span class="hs-identifier hs-var">fps</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679130260"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130260"><span class="hs-identifier hs-var">mspq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">250000</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Ratio Int
forall a. Integral a =&gt; a -&gt; a -&gt; Ratio a
</span><span class="hs-operator hs-var">%</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130259"><span class="hs-identifier hs-var">tps</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130260"><span class="hs-identifier hs-var">mspq</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">1.0</span></span><span> </span><span class="annot"><span class="annottext">Double -&gt; Double -&gt; Double
forall a. Fractional a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">/</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Double
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130260"><span class="hs-identifier hs-var">mspq</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679130259"><span class="annot"><span class="annottext">tps :: Int
</span><a href="#local-6989586621679130259"><span class="hs-identifier hs-var hs-var">tps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130262"><span class="hs-identifier hs-var">tpf</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130261"><span class="hs-identifier hs-var">fps</span></a></span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span class="hs-keyword">type</span><span> </span><span id="Resolver"><span class="annot"><a href="Musicology.IO.MidiFile.html#Resolver"><span class="hs-identifier hs-var">Resolver</span></a></span></span><span> </span><span id="local-6989586621679130258"><span class="annot"><a href="#local-6989586621679130258"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679130258"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679130258"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621679130258"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-137"></span><span>
</span><span id="line-138"></span><span id="local-6989586621679130257"><span class="annot"><a href="Musicology.IO.MidiFile.html#queue"><span class="hs-identifier hs-type">queue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Musicology.IO.MidiFile.html#Resolver"><span class="hs-identifier hs-type">Resolver</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679130257"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-139"></span><span id="queue"><span class="annot"><span class="annottext">queue :: Resolver a
</span><a href="Musicology.IO.MidiFile.html#queue"><span class="hs-identifier hs-var hs-var">queue</span></a></span></span><span> </span><span id="local-6989586621679130255"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679130255"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span id="local-6989586621679130254"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679130254"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679130255"><span class="hs-identifier hs-var">ls</span></a></span><span> </span><span class="annot"><span class="annottext">Resolver a
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679130254"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-140"></span><span>
</span><span id="line-141"></span><span id="local-6989586621679130253"><span class="annot"><a href="Musicology.IO.MidiFile.html#stack"><span class="hs-identifier hs-type">stack</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Musicology.IO.MidiFile.html#Resolver"><span class="hs-identifier hs-type">Resolver</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679130253"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-142"></span><span id="stack"><span class="annot"><span class="annottext">stack :: Resolver a
</span><a href="Musicology.IO.MidiFile.html#stack"><span class="hs-identifier hs-var hs-var">stack</span></a></span></span><span> </span><span id="local-6989586621679130251"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679130251"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span id="local-6989586621679130250"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679130250"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679130250"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Resolver a
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621679130251"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span class="hs-keyword">data</span><span> </span><span id="OnVal"><span class="annot"><a href="Musicology.IO.MidiFile.html#OnVal"><span class="hs-identifier hs-var">OnVal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="OnVal"><span class="annot"><a href="Musicology.IO.MidiFile.html#OnVal"><span class="hs-identifier hs-var">OnVal</span></a></span></span><span>
</span><span id="line-145"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="ovNowT"><span class="annot"><span class="annottext">OnVal -&gt; Int
</span><a href="Musicology.IO.MidiFile.html#ovNowT"><span class="hs-identifier hs-var hs-var">ovNowT</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="ovNowW"><span class="annot"><span class="annottext">OnVal -&gt; Ratio Int
</span><a href="Musicology.IO.MidiFile.html#ovNowW"><span class="hs-identifier hs-var hs-var">ovNowW</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ratio</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="ovNowS"><span class="annot"><span class="annottext">OnVal -&gt; Double
</span><a href="Musicology.IO.MidiFile.html#ovNowS"><span class="hs-identifier hs-var hs-var">ovNowS</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span>
</span><span id="line-148"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="ovVel"><span class="annot"><span class="annottext">OnVal -&gt; Int
</span><a href="Musicology.IO.MidiFile.html#ovVel"><span class="hs-identifier hs-var hs-var">ovVel</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-149"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="ovKeySig"><span class="annot"><span class="annottext">OnVal -&gt; Message
</span><a href="Musicology.IO.MidiFile.html#ovKeySig"><span class="hs-identifier hs-var hs-var">ovKeySig</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Message</span></span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="ovBar"><span class="annot"><span class="annottext">OnVal -&gt; Int
</span><a href="Musicology.IO.MidiFile.html#ovBar"><span class="hs-identifier hs-var hs-var">ovBar</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-151"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="ovBeat"><span class="annot"><span class="annottext">OnVal -&gt; Int
</span><a href="Musicology.IO.MidiFile.html#ovBeat"><span class="hs-identifier hs-var hs-var">ovBeat</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-152"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="ovSubbeat"><span class="annot"><span class="annottext">OnVal -&gt; Ratio Int
</span><a href="Musicology.IO.MidiFile.html#ovSubbeat"><span class="hs-identifier hs-var hs-var">ovSubbeat</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ratio</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-153"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-154"></span><span class="hs-keyword">type</span><span> </span><span id="Ons"><span class="annot"><a href="Musicology.IO.MidiFile.html#Ons"><span class="hs-identifier hs-var">Ons</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.HashMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Musicology.IO.MidiFile.html#OnVal"><span class="hs-identifier hs-type">OnVal</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-155"></span><span class="hs-keyword">type</span><span> </span><span id="Coeffs"><span class="annot"><a href="Musicology.IO.MidiFile.html#Coeffs"><span class="hs-identifier hs-var">Coeffs</span></a></span></span><span> </span><span id="local-6989586621679130240"><span class="annot"><a href="#local-6989586621679130240"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679130240"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621679130240"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-156"></span><span class="hs-keyword">data</span><span> </span><span id="MidiState"><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiState"><span class="hs-identifier hs-var">MidiState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="MidiState"><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiState"><span class="hs-identifier hs-var">MidiState</span></a></span></span><span>
</span><span id="line-157"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="msOns"><span class="annot"><span class="annottext">MidiState -&gt; Ons
</span><a href="Musicology.IO.MidiFile.html#msOns"><span class="hs-identifier hs-var hs-var">msOns</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Musicology.IO.MidiFile.html#Ons"><span class="hs-identifier hs-type">Ons</span></a></span><span>
</span><span id="line-158"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="msWCoeffs"><span class="annot"><span class="annottext">MidiState -&gt; Coeffs (Ratio Int)
</span><a href="Musicology.IO.MidiFile.html#msWCoeffs"><span class="hs-identifier hs-var hs-var">msWCoeffs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Musicology.IO.MidiFile.html#Coeffs"><span class="hs-identifier hs-type">Coeffs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Ratio</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-159"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="msSCoeffs"><span class="annot"><span class="annottext">MidiState -&gt; Coeffs Double
</span><a href="Musicology.IO.MidiFile.html#msSCoeffs"><span class="hs-identifier hs-var hs-var">msSCoeffs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Musicology.IO.MidiFile.html#Coeffs"><span class="hs-identifier hs-type">Coeffs</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span>
</span><span id="line-160"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="msBarOff"><span class="annot"><span class="annottext">MidiState -&gt; Ratio Int
</span><a href="Musicology.IO.MidiFile.html#msBarOff"><span class="hs-identifier hs-var hs-var">msBarOff</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ratio</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-161"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="msBarRef"><span class="annot"><span class="annottext">MidiState -&gt; Int
</span><a href="Musicology.IO.MidiFile.html#msBarRef"><span class="hs-identifier hs-var hs-var">msBarRef</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-162"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="msBarLen"><span class="annot"><span class="annottext">MidiState -&gt; Ratio Int
</span><a href="Musicology.IO.MidiFile.html#msBarLen"><span class="hs-identifier hs-var hs-var">msBarLen</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ratio</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-163"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="msBeatLen"><span class="annot"><span class="annottext">MidiState -&gt; Ratio Int
</span><a href="Musicology.IO.MidiFile.html#msBeatLen"><span class="hs-identifier hs-var hs-var">msBeatLen</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ratio</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-164"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span class="annot"><a href="Musicology.IO.MidiFile.html#eventsToNotes"><span class="hs-identifier hs-type">eventsToNotes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Musicology.IO.MidiFile.html#PrepEv"><span class="hs-identifier hs-type">PrepEv</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ticks</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TimeDiv</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Musicology.IO.MidiFile.html#Resolver"><span class="hs-identifier hs-type">Resolver</span></a></span><span> </span><span class="annot"><a href="Musicology.IO.MidiFile.html#OnVal"><span class="hs-identifier hs-type">OnVal</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiNote"><span class="hs-identifier hs-type">MidiNote</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-167"></span><span id="eventsToNotes"><span class="annot"><span class="annottext">eventsToNotes :: [PrepEv Int] -&gt; TimeDiv -&gt; Resolver OnVal -&gt; [MidiNote]
</span><a href="Musicology.IO.MidiFile.html#eventsToNotes"><span class="hs-identifier hs-var hs-var">eventsToNotes</span></a></span></span><span> </span><span id="local-6989586621679130230"><span class="annot"><span class="annottext">[PrepEv Int]
</span><a href="#local-6989586621679130230"><span class="hs-identifier hs-var">evs</span></a></span></span><span> </span><span id="local-6989586621679130229"><span class="annot"><span class="annottext">TimeDiv
</span><a href="#local-6989586621679130229"><span class="hs-identifier hs-var">tdiv</span></a></span></span><span> </span><span id="local-6989586621679130228"><span class="annot"><span class="annottext">Resolver OnVal
</span><a href="#local-6989586621679130228"><span class="hs-identifier hs-var">insNote</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(MidiNote -&gt; (Int, Int, Int)) -&gt; [MidiNote] -&gt; [MidiNote]
forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sortOn</span></span><span> </span><span class="annot"><span class="annottext">MidiNote -&gt; (Int, Int, Int)
</span><a href="#local-6989586621679130227"><span class="hs-identifier hs-var">sorting</span></a></span><span> </span><span class="annot"><span class="annottext">[MidiNote]
</span><a href="#local-6989586621679130226"><span class="hs-identifier hs-var">notes</span></a></span><span> </span><span>
</span><span id="line-168"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679130226"><span class="annot"><span class="annottext">notes :: [MidiNote]
</span><a href="#local-6989586621679130226"><span class="hs-identifier hs-var hs-var">notes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Maybe MidiNote] -&gt; [MidiNote]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">([Maybe MidiNote] -&gt; [MidiNote]) -&gt; [Maybe MidiNote] -&gt; [MidiNote]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(MidiState, [Maybe MidiNote]) -&gt; [Maybe MidiNote]
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((MidiState, [Maybe MidiNote]) -&gt; [Maybe MidiNote])
-&gt; (MidiState, [Maybe MidiNote]) -&gt; [Maybe MidiNote]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(MidiState -&gt; PrepEv Int -&gt; (MidiState, Maybe MidiNote))
-&gt; MidiState -&gt; [PrepEv Int] -&gt; (MidiState, [Maybe MidiNote])
forall (t :: * -&gt; *) a b c.
Traversable t =&gt;
(a -&gt; b -&gt; (a, c)) -&gt; a -&gt; t b -&gt; (a, t c)
</span><span class="hs-identifier hs-var">mapAccumL</span></span><span> </span><span class="annot"><span class="annottext">MidiState -&gt; PrepEv Int -&gt; (MidiState, Maybe MidiNote)
</span><a href="#local-6989586621679130225"><span class="hs-identifier hs-var">nextEv</span></a></span><span> </span><span class="annot"><span class="annottext">MidiState
</span><a href="#local-6989586621679130224"><span class="hs-identifier hs-var">init</span></a></span><span> </span><span class="annot"><span class="annottext">[PrepEv Int]
</span><a href="#local-6989586621679130230"><span class="hs-identifier hs-var">evs</span></a></span><span>
</span><span id="line-169"></span><span>        </span><span id="local-6989586621679130227"><span class="annot"><span class="annottext">sorting :: MidiNote -&gt; (Int, Int, Int)
</span><a href="#local-6989586621679130227"><span class="hs-identifier hs-var hs-var">sorting</span></a></span></span><span> </span><span id="local-6989586621679130223"><span class="annot"><span class="annottext">MidiNote
</span><a href="#local-6989586621679130223"><span class="hs-identifier hs-var">note</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MidiNote -&gt; Int
</span><a href="Musicology.IO.MidiFile.html#_onsetTicks"><span class="hs-identifier hs-var hs-var">_onsetTicks</span></a></span><span> </span><span class="annot"><span class="annottext">MidiNote
</span><a href="#local-6989586621679130223"><span class="hs-identifier hs-var">note</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MidiNote -&gt; Int
</span><a href="Musicology.IO.MidiFile.html#_trackNum"><span class="hs-identifier hs-var hs-var">_trackNum</span></a></span><span> </span><span class="annot"><span class="annottext">MidiNote
</span><a href="#local-6989586621679130223"><span class="hs-identifier hs-var">note</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MidiNote -&gt; Int
</span><a href="Musicology.IO.MidiFile.html#_channel"><span class="hs-identifier hs-var hs-var">_channel</span></a></span><span> </span><span class="annot"><span class="annottext">MidiNote
</span><a href="#local-6989586621679130223"><span class="hs-identifier hs-var">note</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span>        </span><span id="local-6989586621679130222"><span class="annot"><span class="annottext">toTime :: a -&gt; (b, b) -&gt; b
</span><a href="#local-6989586621679130222"><span class="hs-identifier hs-var hs-var">toTime</span></a></span></span><span> </span><span id="local-6989586621679130221"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679130221"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621679130220"><span class="annot"><span class="annottext">(b, b)
</span><a href="#local-6989586621679130220"><span class="hs-identifier hs-var">coeffs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; b
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679130221"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; b -&gt; b
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(b, b) -&gt; b
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">(b, b)
</span><a href="#local-6989586621679130220"><span class="hs-identifier hs-var">coeffs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">b -&gt; b -&gt; b
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(b, b) -&gt; b
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(b, b)
</span><a href="#local-6989586621679130220"><span class="hs-identifier hs-var">coeffs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-171"></span><span>        </span><span id="local-6989586621679130218"><span class="annot"><span class="annottext">newCoeffs :: a -&gt; b -&gt; b -&gt; (b, b)
</span><a href="#local-6989586621679130218"><span class="hs-identifier hs-var hs-var">newCoeffs</span></a></span></span><span> </span><span id="local-6989586621679130217"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679130217"><span class="hs-identifier hs-var">tks</span></a></span></span><span> </span><span id="local-6989586621679130216"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679130216"><span class="hs-identifier hs-var">now</span></a></span></span><span> </span><span id="local-6989586621679130215"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679130215"><span class="hs-identifier hs-var">ratio</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679130216"><span class="hs-identifier hs-var">now</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; b -&gt; b
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679130215"><span class="hs-identifier hs-var">ratio</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; b -&gt; b
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; b
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679130217"><span class="hs-identifier hs-var">tks</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621679130215"><span class="hs-identifier hs-var">ratio</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-172"></span><span>        </span><span id="local-6989586621679130214"><span class="annot"><span class="annottext">initRatios :: (Ratio Int, Double)
</span><a href="#local-6989586621679130214"><span class="hs-identifier hs-var hs-var">initRatios</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TimeDiv -&gt; Int -&gt; (Ratio Int, Double)
</span><a href="Musicology.IO.MidiFile.html#timeRatios"><span class="hs-identifier hs-var">timeRatios</span></a></span><span> </span><span class="annot"><span class="annottext">TimeDiv
</span><a href="#local-6989586621679130229"><span class="hs-identifier hs-var">tdiv</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">500000</span></span><span>
</span><span id="line-173"></span><span>        </span><span id="local-6989586621679130224"><span class="annot"><span class="annottext">init :: MidiState
</span><a href="#local-6989586621679130224"><span class="hs-identifier hs-var hs-var">init</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ons
-&gt; Coeffs (Ratio Int)
-&gt; Coeffs Double
-&gt; Ratio Int
-&gt; Int
-&gt; Ratio Int
-&gt; Ratio Int
-&gt; MidiState
</span><a href="Musicology.IO.MidiFile.html#MidiState"><span class="hs-identifier hs-var">MidiState</span></a></span><span> </span><span class="annot"><span class="annottext">Ons
forall k v. HashMap k v
</span><span class="hs-identifier hs-var">M.empty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Ratio Int
forall a. Integral a =&gt; a -&gt; a -&gt; Ratio a
</span><span class="hs-operator hs-var">%</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(Ratio Int, Double) -&gt; Ratio Int
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(Ratio Int, Double)
</span><a href="#local-6989586621679130214"><span class="hs-identifier hs-var">initRatios</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">0.0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(Ratio Int, Double) -&gt; Double
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">(Ratio Int, Double)
</span><a href="#local-6989586621679130214"><span class="hs-identifier hs-var">initRatios</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Ratio Int
forall a. Integral a =&gt; a -&gt; a -&gt; Ratio a
</span><span class="hs-operator hs-var">%</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Ratio Int
forall a. Integral a =&gt; a -&gt; a -&gt; Ratio a
</span><span class="hs-operator hs-var">%</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Ratio Int
forall a. Integral a =&gt; a -&gt; a -&gt; Ratio a
</span><span class="hs-operator hs-var">%</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">4</span></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span>        </span><span class="annot"><a href="#local-6989586621679130225"><span class="hs-identifier hs-type">nextEv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiState"><span class="hs-identifier hs-type">MidiState</span></a></span><span>
</span><span id="line-176"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Musicology.IO.MidiFile.html#PrepEv"><span class="hs-identifier hs-type">PrepEv</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ticks</span></span><span>
</span><span id="line-177"></span><span>               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiState"><span class="hs-identifier hs-type">MidiState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiNote"><span class="hs-identifier hs-type">MidiNote</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-178"></span><span>        </span><span id="local-6989586621679130225"><span class="annot"><span class="annottext">nextEv :: MidiState -&gt; PrepEv Int -&gt; (MidiState, Maybe MidiNote)
</span><a href="#local-6989586621679130225"><span class="hs-identifier hs-var hs-var">nextEv</span></a></span></span><span>
</span><span id="line-179"></span><span>          </span><span id="local-6989586621679130212"><span class="annot"><span class="annottext">st :: MidiState
</span><a href="#local-6989586621679130212"><span class="hs-identifier hs-var">st</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiState"><span class="hs-identifier hs-type">MidiState</span></a></span><span> </span><span id="local-6989586621679130211"><span class="annot"><span class="annottext">Ons
</span><a href="#local-6989586621679130211"><span class="hs-identifier hs-var">ons</span></a></span></span><span> </span><span id="local-6989586621679130210"><span class="annot"><span class="annottext">Coeffs (Ratio Int)
</span><a href="#local-6989586621679130210"><span class="hs-identifier hs-var">wcoeffs</span></a></span></span><span> </span><span id="local-6989586621679130209"><span class="annot"><span class="annottext">Coeffs Double
</span><a href="#local-6989586621679130209"><span class="hs-identifier hs-var">scoeffs</span></a></span></span><span> </span><span id="local-6989586621679130208"><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130208"><span class="hs-identifier hs-var">baroff</span></a></span></span><span> </span><span id="local-6989586621679130207"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130207"><span class="hs-identifier hs-var">barref</span></a></span></span><span> </span><span id="local-6989586621679130206"><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130206"><span class="hs-identifier hs-var">barlen</span></a></span></span><span> </span><span id="local-6989586621679130205"><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130205"><span class="hs-identifier hs-var">beatlen</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621679130204"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130204"><span class="hs-identifier hs-var">trackid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679130203"><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679130203"><span class="hs-identifier hs-var">keysig</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679130202"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130202"><span class="hs-identifier hs-var">nowt</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679130201"><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679130201"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span>          </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Message -&gt; (MidiState, Maybe MidiNote)
</span><a href="#local-6989586621679130200"><span class="hs-identifier hs-var">processMsg</span></a></span><span> </span><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679130201"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-182"></span><span>          </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679130199"><span class="annot"><span class="annottext">noww :: Ratio Int
</span><a href="#local-6989586621679130199"><span class="hs-identifier hs-var hs-var">noww</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Coeffs (Ratio Int) -&gt; Ratio Int
forall a b. (Integral a, Num b) =&gt; a -&gt; (b, b) -&gt; b
</span><a href="#local-6989586621679130222"><span class="hs-identifier hs-var">toTime</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130202"><span class="hs-identifier hs-var">nowt</span></a></span><span> </span><span class="annot"><span class="annottext">Coeffs (Ratio Int)
</span><a href="#local-6989586621679130210"><span class="hs-identifier hs-var">wcoeffs</span></a></span><span>
</span><span id="line-183"></span><span>                </span><span id="local-6989586621679130198"><span class="annot"><span class="annottext">nows :: Double
</span><a href="#local-6989586621679130198"><span class="hs-identifier hs-var hs-var">nows</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Coeffs Double -&gt; Double
forall a b. (Integral a, Num b) =&gt; a -&gt; (b, b) -&gt; b
</span><a href="#local-6989586621679130222"><span class="hs-identifier hs-var">toTime</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130202"><span class="hs-identifier hs-var">nowt</span></a></span><span> </span><span class="annot"><span class="annottext">Coeffs Double
</span><a href="#local-6989586621679130209"><span class="hs-identifier hs-var">scoeffs</span></a></span><span>
</span><span id="line-184"></span><span>                </span><span id="local-6989586621679130197"><span class="annot"><span class="annottext">relbar :: Ratio Int
</span><a href="#local-6989586621679130197"><span class="hs-identifier hs-var hs-var">relbar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130199"><span class="hs-identifier hs-var">noww</span></a></span><span> </span><span class="annot"><span class="annottext">Ratio Int -&gt; Ratio Int -&gt; Ratio Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130208"><span class="hs-identifier hs-var">baroff</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Ratio Int -&gt; Ratio Int -&gt; Ratio Int
forall a. Fractional a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">/</span></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130206"><span class="hs-identifier hs-var">barlen</span></a></span><span>
</span><span id="line-185"></span><span>                </span><span class="hs-special">(</span><span id="local-6989586621679130196"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130196"><span class="hs-identifier hs-var">rawbar</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679130195"><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130195"><span class="hs-identifier hs-var">inbar</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ratio Int -&gt; (Int, Ratio Int)
forall a b. (RealFrac a, Integral b) =&gt; a -&gt; (b, a)
</span><span class="hs-identifier hs-var">properFraction</span></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130197"><span class="hs-identifier hs-var">relbar</span></a></span><span>
</span><span id="line-186"></span><span>                </span><span id="local-6989586621679130193"><span class="annot"><span class="annottext">nowbar :: Int
</span><a href="#local-6989586621679130193"><span class="hs-identifier hs-var hs-var">nowbar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130207"><span class="hs-identifier hs-var">barref</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130196"><span class="hs-identifier hs-var">rawbar</span></a></span><span>
</span><span id="line-187"></span><span>                </span><span class="hs-special">(</span><span id="local-6989586621679130192"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130192"><span class="hs-identifier hs-var">nowbeat</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679130191"><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130191"><span class="hs-identifier hs-var">nowsubb</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ratio Int -&gt; (Int, Ratio Int)
forall a b. (RealFrac a, Integral b) =&gt; a -&gt; (b, a)
</span><span class="hs-identifier hs-var">properFraction</span></span><span> </span><span class="annot"><span class="annottext">(Ratio Int -&gt; (Int, Ratio Int)) -&gt; Ratio Int -&gt; (Int, Ratio Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130195"><span class="hs-identifier hs-var">inbar</span></a></span><span> </span><span class="annot"><span class="annottext">Ratio Int -&gt; Ratio Int -&gt; Ratio Int
forall a. Fractional a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">/</span></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130205"><span class="hs-identifier hs-var">beatlen</span></a></span><span>
</span><span id="line-188"></span><span>                </span><span>
</span><span id="line-189"></span><span>                </span><span class="annot"><a href="#local-6989586621679130200"><span class="hs-identifier hs-type">processMsg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Message</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiState"><span class="hs-identifier hs-type">MidiState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiNote"><span class="hs-identifier hs-type">MidiNote</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span>                </span><span id="local-6989586621679130200"><span class="annot"><span class="annottext">processMsg :: Message -&gt; (MidiState, Maybe MidiNote)
</span><a href="#local-6989586621679130200"><span class="hs-identifier hs-var hs-var">processMsg</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TempoChange</span></span><span> </span><span id="local-6989586621679130189"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130189"><span class="hs-identifier hs-var">tempo</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MidiState
</span><a href="#local-6989586621679130188"><span class="hs-identifier hs-var">st'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe MidiNote
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>                  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679130187"><span class="annot"><span class="annottext">ratios :: (Ratio Int, Double)
</span><a href="#local-6989586621679130187"><span class="hs-identifier hs-var hs-var">ratios</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TimeDiv -&gt; Int -&gt; (Ratio Int, Double)
</span><a href="Musicology.IO.MidiFile.html#timeRatios"><span class="hs-identifier hs-var">timeRatios</span></a></span><span> </span><span class="annot"><span class="annottext">TimeDiv
</span><a href="#local-6989586621679130229"><span class="hs-identifier hs-var">tdiv</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130189"><span class="hs-identifier hs-var">tempo</span></a></span><span>
</span><span id="line-193"></span><span>                        </span><span id="local-6989586621679130188"><span class="annot"><span class="annottext">st' :: MidiState
</span><a href="#local-6989586621679130188"><span class="hs-identifier hs-var hs-var">st'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MidiState
</span><a href="#local-6989586621679130212"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">msWCoeffs :: Coeffs (Ratio Int)
</span><a href="Musicology.IO.MidiFile.html#msWCoeffs"><span class="hs-identifier hs-var">msWCoeffs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Ratio Int -&gt; Ratio Int -&gt; Coeffs (Ratio Int)
forall a b. (Integral a, Num b) =&gt; a -&gt; b -&gt; b -&gt; (b, b)
</span><a href="#local-6989586621679130218"><span class="hs-identifier hs-var">newCoeffs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130202"><span class="hs-identifier hs-var">nowt</span></a></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130199"><span class="hs-identifier hs-var">noww</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Ratio Int, Double) -&gt; Ratio Int
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(Ratio Int, Double)
</span><a href="#local-6989586621679130187"><span class="hs-identifier hs-var">ratios</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>                                 </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">msSCoeffs :: Coeffs Double
</span><a href="Musicology.IO.MidiFile.html#msSCoeffs"><span class="hs-identifier hs-var">msSCoeffs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Double -&gt; Double -&gt; Coeffs Double
forall a b. (Integral a, Num b) =&gt; a -&gt; b -&gt; b -&gt; (b, b)
</span><a href="#local-6989586621679130218"><span class="hs-identifier hs-var">newCoeffs</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130202"><span class="hs-identifier hs-var">nowt</span></a></span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679130198"><span class="hs-identifier hs-var">nows</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Ratio Int, Double) -&gt; Double
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">(Ratio Int, Double)
</span><a href="#local-6989586621679130187"><span class="hs-identifier hs-var">ratios</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-195"></span><span>
</span><span id="line-196"></span><span>                </span><span class="annot"><a href="#local-6989586621679130200"><span class="hs-identifier hs-var">processMsg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TimeSignature</span></span><span> </span><span id="local-6989586621679130185"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130185"><span class="hs-identifier hs-var">num</span></a></span></span><span> </span><span id="local-6989586621679130184"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130184"><span class="hs-identifier hs-var">den</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MidiState
</span><a href="#local-6989586621679130183"><span class="hs-identifier hs-var">st'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe MidiNote
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-197"></span><span>                  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679130182"><span class="annot"><span class="annottext">ref' :: Int
</span><a href="#local-6989586621679130182"><span class="hs-identifier hs-var hs-var">ref'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130195"><span class="hs-identifier hs-var">inbar</span></a></span><span> </span><span class="annot"><span class="annottext">Ratio Int -&gt; Ratio Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130193"><span class="hs-identifier hs-var">nowbar</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130193"><span class="hs-identifier hs-var">nowbar</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-198"></span><span>                        </span><span id="local-6989586621679130181"><span class="annot"><span class="annottext">denom :: Int
</span><a href="#local-6989586621679130181"><span class="hs-identifier hs-var hs-var">denom</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a b. (Num a, Integral b) =&gt; a -&gt; b -&gt; a
</span><span class="hs-operator hs-var">^</span></span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130184"><span class="hs-identifier hs-var">den</span></a></span><span> </span><span class="hs-comment">-- by MIDI standard, denom is encoded as exponent of 2</span><span>
</span><span id="line-199"></span><span>                        </span><span id="local-6989586621679130183"><span class="annot"><span class="annottext">st' :: MidiState
</span><a href="#local-6989586621679130183"><span class="hs-identifier hs-var hs-var">st'</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MidiState
</span><a href="#local-6989586621679130212"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">msBarOff :: Ratio Int
</span><a href="Musicology.IO.MidiFile.html#msBarOff"><span class="hs-identifier hs-var">msBarOff</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130199"><span class="hs-identifier hs-var">noww</span></a></span><span>
</span><span id="line-200"></span><span>                                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">msBarRef :: Int
</span><a href="Musicology.IO.MidiFile.html#msBarRef"><span class="hs-identifier hs-var">msBarRef</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130182"><span class="hs-identifier hs-var">ref'</span></a></span><span>
</span><span id="line-201"></span><span>                                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">msBarLen :: Ratio Int
</span><a href="Musicology.IO.MidiFile.html#msBarLen"><span class="hs-identifier hs-var">msBarLen</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130185"><span class="hs-identifier hs-var">num</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Ratio Int
forall a. Integral a =&gt; a -&gt; a -&gt; Ratio a
</span><span class="hs-operator hs-var">%</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130181"><span class="hs-identifier hs-var">denom</span></a></span><span>
</span><span id="line-202"></span><span>                                   </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">msBeatLen :: Ratio Int
</span><a href="Musicology.IO.MidiFile.html#msBeatLen"><span class="hs-identifier hs-var">msBeatLen</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Ratio Int
forall a. Integral a =&gt; a -&gt; a -&gt; Ratio a
</span><span class="hs-operator hs-var">%</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130181"><span class="hs-identifier hs-var">denom</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-203"></span><span>
</span><span id="line-204"></span><span>                </span><span class="annot"><a href="#local-6989586621679130200"><span class="hs-identifier hs-var">processMsg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">NoteOn</span></span><span> </span><span id="local-6989586621679130178"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130178"><span class="hs-identifier hs-var">ch</span></a></span></span><span> </span><span id="local-6989586621679130177"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130177"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Message -&gt; (MidiState, Maybe MidiNote)
</span><a href="#local-6989586621679130200"><span class="hs-identifier hs-var">processMsg</span></a></span><span> </span><span class="annot"><span class="annottext">(Message -&gt; (MidiState, Maybe MidiNote))
-&gt; Message -&gt; (MidiState, Maybe MidiNote)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int -&gt; Message
</span><span class="hs-identifier hs-var">NoteOff</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130178"><span class="hs-identifier hs-var">ch</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130177"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span>                </span><span class="annot"><a href="#local-6989586621679130200"><span class="hs-identifier hs-var">processMsg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">NoteOn</span></span><span> </span><span id="local-6989586621679130175"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130175"><span class="hs-identifier hs-var">ch</span></a></span></span><span> </span><span id="local-6989586621679130174"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130174"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679130173"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130173"><span class="hs-identifier hs-var">vel</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MidiState
</span><a href="#local-6989586621679130212"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">msOns :: Ons
</span><a href="Musicology.IO.MidiFile.html#msOns"><span class="hs-identifier hs-var">msOns</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ons
</span><a href="#local-6989586621679130172"><span class="hs-identifier hs-var">ons'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe MidiNote
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-207"></span><span>                  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679130171"><span class="annot"><span class="annottext">nKey :: (Int, Int, Int)
</span><a href="#local-6989586621679130171"><span class="hs-identifier hs-var hs-var">nKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130204"><span class="hs-identifier hs-var">trackid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130175"><span class="hs-identifier hs-var">ch</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130174"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-208"></span><span>                        </span><span id="local-6989586621679130170"><span class="annot"><span class="annottext">nVal :: OnVal
</span><a href="#local-6989586621679130170"><span class="hs-identifier hs-var hs-var">nVal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Ratio Int
-&gt; Double
-&gt; Int
-&gt; Message
-&gt; Int
-&gt; Int
-&gt; Ratio Int
-&gt; OnVal
</span><a href="Musicology.IO.MidiFile.html#OnVal"><span class="hs-identifier hs-var">OnVal</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130202"><span class="hs-identifier hs-var">nowt</span></a></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130199"><span class="hs-identifier hs-var">noww</span></a></span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679130198"><span class="hs-identifier hs-var">nows</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130173"><span class="hs-identifier hs-var">vel</span></a></span><span> </span><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679130203"><span class="hs-identifier hs-var">keysig</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130193"><span class="hs-identifier hs-var">nowbar</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130192"><span class="hs-identifier hs-var">nowbeat</span></a></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130191"><span class="hs-identifier hs-var">nowsubb</span></a></span><span>
</span><span id="line-209"></span><span>                        </span><span id="local-6989586621679130172"><span class="annot"><span class="annottext">ons' :: Ons
</span><a href="#local-6989586621679130172"><span class="hs-identifier hs-var hs-var">ons'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Resolver OnVal -&gt; (Int, Int, Int) -&gt; [OnVal] -&gt; Ons -&gt; Ons
forall k v.
(Eq k, Hashable k) =&gt;
(v -&gt; v -&gt; v) -&gt; k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">M.insertWith</span></span><span> </span><span class="annot"><span class="annottext">Resolver OnVal
</span><a href="#local-6989586621679130228"><span class="hs-identifier hs-var">insNote</span></a></span><span> </span><span class="annot"><span class="annottext">(Int, Int, Int)
</span><a href="#local-6989586621679130171"><span class="hs-identifier hs-var">nKey</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">OnVal
</span><a href="#local-6989586621679130170"><span class="hs-identifier hs-var">nVal</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Ons
</span><a href="#local-6989586621679130211"><span class="hs-identifier hs-var">ons</span></a></span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span>                </span><span class="annot"><a href="#local-6989586621679130200"><span class="hs-identifier hs-var">processMsg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">NoteOff</span></span><span> </span><span id="local-6989586621679130168"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130168"><span class="hs-identifier hs-var">ch</span></a></span></span><span> </span><span id="local-6989586621679130167"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130167"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679130166"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130166"><span class="hs-identifier hs-var">vel</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MidiState
</span><a href="#local-6989586621679130212"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">msOns :: Ons
</span><a href="Musicology.IO.MidiFile.html#msOns"><span class="hs-identifier hs-var">msOns</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ons
</span><a href="#local-6989586621679130165"><span class="hs-identifier hs-var">ons'</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe MidiNote
</span><a href="#local-6989586621679130164"><span class="hs-identifier hs-var">note</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>                  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679130163"><span class="annot"><span class="annottext">nKey :: (Int, Int, Int)
</span><a href="#local-6989586621679130163"><span class="hs-identifier hs-var hs-var">nKey</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130204"><span class="hs-identifier hs-var">trackid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130168"><span class="hs-identifier hs-var">ch</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130167"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-213"></span><span>                        </span><span id="local-6989586621679130162"><span class="annot"><span class="annottext">open :: [OnVal]
</span><a href="#local-6989586621679130162"><span class="hs-identifier hs-var hs-var">open</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[OnVal] -&gt; (Int, Int, Int) -&gt; Ons -&gt; [OnVal]
forall k v. (Eq k, Hashable k) =&gt; v -&gt; k -&gt; HashMap k v -&gt; v
</span><span class="hs-identifier hs-var">M.lookupDefault</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Int, Int, Int)
</span><a href="#local-6989586621679130163"><span class="hs-identifier hs-var">nKey</span></a></span><span> </span><span class="annot"><span class="annottext">Ons
</span><a href="#local-6989586621679130211"><span class="hs-identifier hs-var">ons</span></a></span><span>
</span><span id="line-214"></span><span>                        </span><span id="local-6989586621679130164"><span class="annot"><span class="annottext">note :: Maybe MidiNote
</span><a href="#local-6989586621679130164"><span class="hs-identifier hs-var hs-var">note</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[OnVal]
</span><a href="#local-6989586621679130162"><span class="hs-identifier hs-var">open</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-215"></span><span>                                 </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe MidiNote
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-216"></span><span>                                 </span><span class="hs-special">(</span><span class="annot"><a href="Musicology.IO.MidiFile.html#OnVal"><span class="hs-identifier hs-type">OnVal</span></a></span><span> </span><span id="local-6989586621679130160"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130160"><span class="hs-identifier hs-var">ont</span></a></span></span><span> </span><span id="local-6989586621679130159"><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130159"><span class="hs-identifier hs-var">onw</span></a></span></span><span> </span><span id="local-6989586621679130158"><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679130158"><span class="hs-identifier hs-var">ons</span></a></span></span><span> </span><span id="local-6989586621679130157"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130157"><span class="hs-identifier hs-var">onvel</span></a></span></span><span>
</span><span id="line-217"></span><span>                                  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">KeySignature</span></span><span> </span><span id="local-6989586621679130156"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130156"><span class="hs-identifier hs-var">sh</span></a></span></span><span> </span><span id="local-6989586621679130155"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130155"><span class="hs-identifier hs-var">mode</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679130154"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130154"><span class="hs-identifier hs-var">bar</span></a></span></span><span> </span><span id="local-6989586621679130153"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130153"><span class="hs-identifier hs-var">beat</span></a></span></span><span> </span><span id="local-6989586621679130152"><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130152"><span class="hs-identifier hs-var">subb</span></a></span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[OnVal]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-218"></span><span>                                   </span><span class="annot"><span class="annottext">MidiNote -&gt; Maybe MidiNote
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(MidiNote -&gt; Maybe MidiNote) -&gt; MidiNote -&gt; Maybe MidiNote
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Int
-&gt; Ratio Int
-&gt; Ratio Int
-&gt; Double
-&gt; Double
-&gt; MidiPitch
-&gt; Int
-&gt; Int
-&gt; Int
-&gt; Int
-&gt; Bool
-&gt; Int
-&gt; Int
-&gt; Ratio Int
-&gt; MidiNote
</span><a href="Musicology.IO.MidiFile.html#MidiNote"><span class="hs-identifier hs-var">MidiNote</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130160"><span class="hs-identifier hs-var">ont</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130202"><span class="hs-identifier hs-var">nowt</span></a></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130159"><span class="hs-identifier hs-var">onw</span></a></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130199"><span class="hs-identifier hs-var">noww</span></a></span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679130158"><span class="hs-identifier hs-var">ons</span></a></span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679130198"><span class="hs-identifier hs-var">nows</span></a></span><span>
</span><span id="line-219"></span><span>                                   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; MidiPitch
forall a. a -&gt; Pitch a
</span><span class="hs-identifier hs-var">toPitch</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130167"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130157"><span class="hs-identifier hs-var">onvel</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130204"><span class="hs-identifier hs-var">trackid</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130168"><span class="hs-identifier hs-var">ch</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130156"><span class="hs-identifier hs-var">sh</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130155"><span class="hs-identifier hs-var">mode</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130154"><span class="hs-identifier hs-var">bar</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130153"><span class="hs-identifier hs-var">beat</span></a></span><span> </span><span class="annot"><span class="annottext">Ratio Int
</span><a href="#local-6989586621679130152"><span class="hs-identifier hs-var">subb</span></a></span><span>
</span><span id="line-220"></span><span>                        </span><span id="local-6989586621679130165"><span class="annot"><span class="annottext">ons' :: Ons
</span><a href="#local-6989586621679130165"><span class="hs-identifier hs-var hs-var">ons'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[OnVal]
</span><a href="#local-6989586621679130162"><span class="hs-identifier hs-var">open</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-221"></span><span>                                 </span><span class="hs-special">[</span><span class="hs-special">]</span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Ons
</span><a href="#local-6989586621679130211"><span class="hs-identifier hs-var">ons</span></a></span><span>
</span><span id="line-222"></span><span>                                 </span><span class="annot"><span class="annottext">OnVal
</span><span class="hs-identifier">_</span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679130150"><span class="annot"><span class="annottext">[OnVal]
</span><a href="#local-6989586621679130150"><span class="hs-identifier hs-var">rst</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Int, Int, Int) -&gt; [OnVal] -&gt; Ons -&gt; Ons
forall k v.
(Eq k, Hashable k) =&gt;
k -&gt; v -&gt; HashMap k v -&gt; HashMap k v
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">(Int, Int, Int)
</span><a href="#local-6989586621679130163"><span class="hs-identifier hs-var">nKey</span></a></span><span> </span><span class="annot"><span class="annottext">[OnVal]
</span><a href="#local-6989586621679130150"><span class="hs-identifier hs-var">rst</span></a></span><span> </span><span class="annot"><span class="annottext">Ons
</span><a href="#local-6989586621679130211"><span class="hs-identifier hs-var">ons</span></a></span><span>
</span><span id="line-223"></span><span>
</span><span id="line-224"></span><span>                </span><span class="annot"><a href="#local-6989586621679130200"><span class="hs-identifier hs-var">processMsg</span></a></span><span> </span><span class="annot"><span class="annottext">Message
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MidiState
</span><a href="#local-6989586621679130212"><span class="hs-identifier hs-var">st</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe MidiNote
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span class="hs-comment">-- processNotes :: Monad m =&gt; TimeDiv -&gt; Resolver OnVal -&gt; Pipe (PrepEv Ticks) MidiNote m ()</span><span>
</span><span id="line-227"></span><span class="hs-comment">-- processNotes = undefined</span><span>
</span><span id="line-228"></span><span>
</span><span id="line-229"></span><span class="annot"><a href="Musicology.IO.MidiFile.html#notesToFrame"><span class="hs-identifier hs-type">notesToFrame</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiNote"><span class="hs-identifier hs-type">MidiNote</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Frame</span></span><span> </span><span class="annot"><a href="Musicology.IO.MidiFile.html#MidiRecord"><span class="hs-identifier hs-type">MidiRecord</span></a></span><span>
</span><span id="line-230"></span><span id="notesToFrame"><span class="annot"><span class="annottext">notesToFrame :: [MidiNote] -&gt; Frame MidiRecord
</span><a href="Musicology.IO.MidiFile.html#notesToFrame"><span class="hs-identifier hs-var hs-var">notesToFrame</span></a></span></span><span> </span><span id="local-6989586621679130147"><span class="annot"><span class="annottext">[MidiNote]
</span><a href="#local-6989586621679130147"><span class="hs-identifier hs-var">notes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[MidiRecord] -&gt; Frame MidiRecord
forall (f :: * -&gt; *) (rs :: [(Symbol, *)]).
(Foldable f, RecVec rs) =&gt;
f (Record rs) -&gt; Frame (Record rs)
</span><span class="hs-identifier hs-var">toFrame</span></span><span> </span><span class="annot"><span class="annottext">([MidiRecord] -&gt; Frame MidiRecord)
-&gt; [MidiRecord] -&gt; Frame MidiRecord
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(MidiNote -&gt; MidiRecord) -&gt; [MidiNote] -&gt; [MidiRecord]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">MidiNote -&gt; MidiRecord
</span><a href="Musicology.IO.MidiFile.html#midiNoteToRecord"><span class="hs-identifier hs-var">midiNoteToRecord</span></a></span><span> </span><span class="annot"><span class="annottext">[MidiNote]
</span><a href="#local-6989586621679130147"><span class="hs-identifier hs-var">notes</span></a></span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span class="annot"><a href="Musicology.IO.MidiFile.html#midiTracks"><span class="hs-identifier hs-type">midiTracks</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Track</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Ticks</span></span><span class="hs-special">]</span><span>
</span><span id="line-233"></span><span id="midiTracks"><span class="annot"><span class="annottext">midiTracks :: String -&gt; IO [Track Int]
</span><a href="Musicology.IO.MidiFile.html#midiTracks"><span class="hs-identifier hs-var hs-var">midiTracks</span></a></span></span><span> </span><span id="local-6989586621679130143"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679130143"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-234"></span><span>  </span><span id="local-6989586621679130142"><span class="annot"><span class="annottext">Either String Midi
</span><a href="#local-6989586621679130142"><span class="hs-identifier hs-var">midi</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO (Either String Midi)
</span><span class="hs-identifier hs-var">importFile</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679130143"><span class="hs-identifier hs-var">fp</span></a></span><span>
</span><span id="line-235"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either String Midi
</span><a href="#local-6989586621679130142"><span class="hs-identifier hs-var">midi</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-236"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Track Int] -&gt; IO [Track Int]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-237"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621679130140"><span class="annot"><span class="annottext">Midi
</span><a href="#local-6989586621679130140"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Track Int] -&gt; IO [Track Int]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([Track Int] -&gt; IO [Track Int]) -&gt; [Track Int] -&gt; IO [Track Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Midi -&gt; [Track Int]
</span><span class="hs-identifier hs-var hs-var">tracks</span></span><span> </span><span class="annot"><span class="annottext">Midi
</span><a href="#local-6989586621679130140"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span id="midiLoadEvs"><span class="annot"><span class="annottext">midiLoadEvs :: String -&gt; IO [PrepEv Int]
</span><a href="Musicology.IO.MidiFile.html#midiLoadEvs"><span class="hs-identifier hs-var hs-var">midiLoadEvs</span></a></span></span><span> </span><span id="local-6989586621679130138"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679130138"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-240"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; IO (Either String Midi)
</span><span class="hs-identifier hs-var">importFile</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679130138"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Either String Midi)
-&gt; (Either String Midi -&gt; IO [PrepEv Int]) -&gt; IO [PrepEv Int]
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">[PrepEv Int] -&gt; IO [PrepEv Int]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([PrepEv Int] -&gt; IO [PrepEv Int])
-&gt; (Either String Midi -&gt; [PrepEv Int])
-&gt; Either String Midi
-&gt; IO [PrepEv Int]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; [PrepEv Int])
-&gt; (Midi -&gt; [PrepEv Int]) -&gt; Either String Midi -&gt; [PrepEv Int]
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PrepEv Int] -&gt; String -&gt; [PrepEv Int]
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Midi -&gt; [PrepEv Int]
</span><a href="Musicology.IO.MidiFile.html#midiEvents"><span class="hs-identifier hs-var">midiEvents</span></a></span><span>
</span><span id="line-241"></span><span>
</span><span id="line-242"></span><span id="midiLoadNotes"><span class="annot"><span class="annottext">midiLoadNotes :: String -&gt; IO [MidiNote]
</span><a href="Musicology.IO.MidiFile.html#midiLoadNotes"><span class="hs-identifier hs-var hs-var">midiLoadNotes</span></a></span></span><span> </span><span id="local-6989586621679130133"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679130133"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-243"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; IO (Either String Midi)
</span><span class="hs-identifier hs-var">importFile</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679130133"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Either String Midi)
-&gt; (Either String Midi -&gt; IO [MidiNote]) -&gt; IO [MidiNote]
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">[MidiNote] -&gt; IO [MidiNote]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([MidiNote] -&gt; IO [MidiNote])
-&gt; (Either String Midi -&gt; [MidiNote])
-&gt; Either String Midi
-&gt; IO [MidiNote]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; [MidiNote])
-&gt; (Midi -&gt; [MidiNote]) -&gt; Either String Midi -&gt; [MidiNote]
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[MidiNote] -&gt; String -&gt; [MidiNote]
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Midi -&gt; [MidiNote]
</span><a href="#local-6989586621679130132"><span class="hs-identifier hs-var">loadNotes</span></a></span><span>
</span><span id="line-244"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679130132"><span class="annot"><span class="annottext">loadNotes :: Midi -&gt; [MidiNote]
</span><a href="#local-6989586621679130132"><span class="hs-identifier hs-var hs-var">loadNotes</span></a></span></span><span> </span><span id="local-6989586621679130131"><span class="annot"><span class="annottext">Midi
</span><a href="#local-6989586621679130131"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-245"></span><span>          </span><span class="annot"><span class="annottext">[PrepEv Int] -&gt; TimeDiv -&gt; Resolver OnVal -&gt; [MidiNote]
</span><a href="Musicology.IO.MidiFile.html#eventsToNotes"><span class="hs-identifier hs-var">eventsToNotes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Midi -&gt; [PrepEv Int]
</span><a href="Musicology.IO.MidiFile.html#midiEvents"><span class="hs-identifier hs-var">midiEvents</span></a></span><span> </span><span class="annot"><span class="annottext">Midi
</span><a href="#local-6989586621679130131"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Midi -&gt; TimeDiv
</span><span class="hs-identifier hs-var hs-var">timeDiv</span></span><span> </span><span class="annot"><span class="annottext">Midi
</span><a href="#local-6989586621679130131"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Resolver OnVal
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="Musicology.IO.MidiFile.html#queue"><span class="hs-identifier hs-var">queue</span></a></span><span>
</span><span id="line-246"></span><span>
</span><span id="line-247"></span><span id="pieceBarlen"><span class="annot"><span class="annottext">pieceBarlen :: String -&gt; IO (Ratio Int)
</span><a href="Musicology.IO.MidiFile.html#pieceBarlen"><span class="hs-identifier hs-var hs-var">pieceBarlen</span></a></span></span><span> </span><span id="local-6989586621679130128"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679130128"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-248"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; IO (Either String Midi)
</span><span class="hs-identifier hs-var">importFile</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679130128"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Either String Midi)
-&gt; (Either String Midi -&gt; IO (Ratio Int)) -&gt; IO (Ratio Int)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Ratio Int -&gt; IO (Ratio Int)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Ratio Int -&gt; IO (Ratio Int))
-&gt; (Either String Midi -&gt; Ratio Int)
-&gt; Either String Midi
-&gt; IO (Ratio Int)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Ratio Int)
-&gt; (Midi -&gt; Ratio Int) -&gt; Either String Midi -&gt; Ratio Int
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ratio Int -&gt; String -&gt; Ratio Int
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">(Ratio Int -&gt; String -&gt; Ratio Int)
-&gt; Ratio Int -&gt; String -&gt; Ratio Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Ratio Int
forall a. Integral a =&gt; a -&gt; a -&gt; Ratio a
</span><span class="hs-operator hs-var">%</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Midi -&gt; Ratio Int
</span><a href="#local-6989586621679130127"><span class="hs-identifier hs-var">barlen</span></a></span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679130127"><span class="annot"><span class="annottext">barlen :: Midi -&gt; Ratio Int
</span><a href="#local-6989586621679130127"><span class="hs-identifier hs-var hs-var">barlen</span></a></span></span><span> </span><span id="local-6989586621679130126"><span class="annot"><span class="annottext">Midi
</span><a href="#local-6989586621679130126"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ratio Int
-&gt; (Ratio Int -&gt; Ratio Int) -&gt; Maybe (Ratio Int) -&gt; Ratio Int
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Ratio Int
forall a. Integral a =&gt; a -&gt; a -&gt; Ratio a
</span><span class="hs-operator hs-var">%</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Ratio Int -&gt; Ratio Int
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Track Int] -&gt; Maybe (Track Int)
forall a. [a] -&gt; Maybe a
</span><span class="hs-identifier hs-var">listToMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Midi -&gt; [Track Int]
</span><span class="hs-identifier hs-var hs-var">tracks</span></span><span> </span><span class="annot"><span class="annottext">Midi
</span><a href="#local-6989586621679130126"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe (Track Int)
-&gt; (Track Int -&gt; Maybe (Ratio Int)) -&gt; Maybe (Ratio Int)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Track Int -&gt; Maybe (Ratio Int)
forall a. [(a, Message)] -&gt; Maybe (Ratio Int)
</span><a href="#local-6989586621679130123"><span class="hs-identifier hs-var">findTime</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span>          </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679130123"><span class="annot"><span class="annottext">findTime :: [(a, Message)] -&gt; Maybe (Ratio Int)
</span><a href="#local-6989586621679130123"><span class="hs-identifier hs-var hs-var">findTime</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TimeSignature</span></span><span> </span><span id="local-6989586621679130122"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130122"><span class="hs-identifier hs-var">num</span></a></span></span><span> </span><span id="local-6989586621679130121"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130121"><span class="hs-identifier hs-var">den</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[(a, Message)]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ratio Int -&gt; Maybe (Ratio Int)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Ratio Int -&gt; Maybe (Ratio Int)) -&gt; Ratio Int -&gt; Maybe (Ratio Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130122"><span class="hs-identifier hs-var">num</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Ratio Int
forall a. Integral a =&gt; a -&gt; a -&gt; Ratio a
</span><span class="hs-operator hs-var">%</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a b. (Num a, Integral b) =&gt; a -&gt; b -&gt; a
</span><span class="hs-operator hs-var">^</span></span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130121"><span class="hs-identifier hs-var">den</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-251"></span><span>                </span><span class="annot"><a href="#local-6989586621679130123"><span class="hs-identifier hs-var">findTime</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621679130120"><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679130120"><span class="hs-identifier hs-var">ev</span></a></span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679130119"><span class="annot"><span class="annottext">[(a, Message)]
</span><a href="#local-6989586621679130119"><span class="hs-identifier hs-var">rst</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(a, Message)] -&gt; Maybe (Ratio Int)
</span><a href="#local-6989586621679130123"><span class="hs-identifier hs-var">findTime</span></a></span><span> </span><span class="annot"><span class="annottext">[(a, Message)]
</span><a href="#local-6989586621679130119"><span class="hs-identifier hs-var">rst</span></a></span><span>
</span><span id="line-252"></span><span>                </span><span class="annot"><a href="#local-6989586621679130123"><span class="hs-identifier hs-var">findTime</span></a></span><span> </span><span class="annot"><span class="annottext">[(a, Message)]
</span><span class="hs-identifier">_</span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Ratio Int)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-253"></span><span>
</span><span id="line-254"></span><span id="pieceBeatlen"><span class="annot"><span class="annottext">pieceBeatlen :: String -&gt; IO (Ratio a)
</span><a href="Musicology.IO.MidiFile.html#pieceBeatlen"><span class="hs-identifier hs-var hs-var">pieceBeatlen</span></a></span></span><span> </span><span id="local-6989586621679130117"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679130117"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-255"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; IO (Either String Midi)
</span><span class="hs-identifier hs-var">importFile</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679130117"><span class="hs-identifier hs-var">fp</span></a></span><span> </span><span class="annot"><span class="annottext">IO (Either String Midi)
-&gt; (Either String Midi -&gt; IO (Ratio a)) -&gt; IO (Ratio a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Ratio a -&gt; IO (Ratio a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Ratio a -&gt; IO (Ratio a))
-&gt; (Either String Midi -&gt; Ratio a)
-&gt; Either String Midi
-&gt; IO (Ratio a)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Ratio a)
-&gt; (Midi -&gt; Ratio a) -&gt; Either String Midi -&gt; Ratio a
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ratio a -&gt; String -&gt; Ratio a
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">(Ratio a -&gt; String -&gt; Ratio a) -&gt; Ratio a -&gt; String -&gt; Ratio a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1</span></span><span class="annot"><span class="annottext">a -&gt; a -&gt; Ratio a
forall a. Integral a =&gt; a -&gt; a -&gt; Ratio a
</span><span class="hs-operator hs-var">%</span></span><span class="annot"><span class="annottext">a
</span><span class="hs-number">4</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Midi -&gt; Ratio a
forall a. Integral a =&gt; Midi -&gt; Ratio a
</span><a href="#local-6989586621679130116"><span class="hs-identifier hs-var">barlen</span></a></span><span>
</span><span id="line-256"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679130116"><span class="annot"><span class="annottext">barlen :: Midi -&gt; Ratio a
</span><a href="#local-6989586621679130116"><span class="hs-identifier hs-var hs-var">barlen</span></a></span></span><span> </span><span id="local-6989586621679130115"><span class="annot"><span class="annottext">Midi
</span><a href="#local-6989586621679130115"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ratio a -&gt; (Ratio a -&gt; Ratio a) -&gt; Maybe (Ratio a) -&gt; Ratio a
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1</span></span><span class="annot"><span class="annottext">a -&gt; a -&gt; Ratio a
forall a. Integral a =&gt; a -&gt; a -&gt; Ratio a
</span><span class="hs-operator hs-var">%</span></span><span class="annot"><span class="annottext">a
</span><span class="hs-number">4</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Ratio a -&gt; Ratio a
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Track Int] -&gt; Maybe (Track Int)
forall a. [a] -&gt; Maybe a
</span><span class="hs-identifier hs-var">listToMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Midi -&gt; [Track Int]
</span><span class="hs-identifier hs-var hs-var">tracks</span></span><span> </span><span class="annot"><span class="annottext">Midi
</span><a href="#local-6989586621679130115"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe (Track Int)
-&gt; (Track Int -&gt; Maybe (Ratio a)) -&gt; Maybe (Ratio a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Track Int -&gt; Maybe (Ratio a)
forall a a. Integral a =&gt; [(a, Message)] -&gt; Maybe (Ratio a)
</span><a href="#local-6989586621679130114"><span class="hs-identifier hs-var">findTime</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-257"></span><span>          </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679130114"><span class="annot"><span class="annottext">findTime :: [(a, Message)] -&gt; Maybe (Ratio a)
</span><a href="#local-6989586621679130114"><span class="hs-identifier hs-var hs-var">findTime</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">TimeSignature</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679130113"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130113"><span class="hs-identifier hs-var">den</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span class="annot"><span class="annottext">[(a, Message)]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ratio a -&gt; Maybe (Ratio a)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Ratio a -&gt; Maybe (Ratio a)) -&gt; Ratio a -&gt; Maybe (Ratio a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Ratio a
forall a. Integral a =&gt; a -&gt; a -&gt; Ratio a
</span><span class="hs-operator hs-var">%</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-number">2</span></span><span class="annot"><span class="annottext">a -&gt; Int -&gt; a
forall a b. (Num a, Integral b) =&gt; a -&gt; b -&gt; a
</span><span class="hs-operator hs-var">^</span></span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679130113"><span class="hs-identifier hs-var">den</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>                </span><span class="annot"><a href="#local-6989586621679130114"><span class="hs-identifier hs-var">findTime</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621679130112"><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679130112"><span class="hs-identifier hs-var">ev</span></a></span></span><span class="hs-special">)</span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621679130111"><span class="annot"><span class="annottext">[(a, Message)]
</span><a href="#local-6989586621679130111"><span class="hs-identifier hs-var">rst</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(a, Message)] -&gt; Maybe (Ratio a)
</span><a href="#local-6989586621679130114"><span class="hs-identifier hs-var">findTime</span></a></span><span> </span><span class="annot"><span class="annottext">[(a, Message)]
</span><a href="#local-6989586621679130111"><span class="hs-identifier hs-var">rst</span></a></span><span>
</span><span id="line-259"></span><span>                </span><span class="annot"><a href="#local-6989586621679130114"><span class="hs-identifier hs-var">findTime</span></a></span><span> </span><span class="annot"><span class="annottext">[(a, Message)]
</span><span class="hs-identifier">_</span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Ratio a)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-260"></span><span>
</span><span id="line-261"></span><span class="annot"><a href="Musicology.IO.MidiFile.html#dirMidiPieces"><span class="hs-identifier hs-type">dirMidiPieces</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span class="hs-special">]</span><span>
</span><span id="line-262"></span><span id="dirMidiPieces"><span class="annot"><span class="annottext">dirMidiPieces :: String -&gt; IO [String]
</span><a href="Musicology.IO.MidiFile.html#dirMidiPieces"><span class="hs-identifier hs-var hs-var">dirMidiPieces</span></a></span></span><span> </span><span id="local-6989586621679130109"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679130109"><span class="hs-identifier hs-var">dir</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-263"></span><span>  </span><span id="local-6989586621679130108"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679130108"><span class="hs-identifier hs-var">contents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO [String]
</span><span class="hs-identifier hs-var">listDirectory</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679130109"><span class="hs-identifier hs-var">dir</span></a></span><span>
</span><span id="line-264"></span><span>  </span><span class="annot"><span class="annottext">[String] -&gt; IO [String]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([String] -&gt; IO [String]) -&gt; [String] -&gt; IO [String]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ShowS
</span><span class="hs-identifier hs-var">takeBaseName</span></span><span> </span><span class="annot"><span class="annottext">ShowS -&gt; [String] -&gt; [String]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Bool) -&gt; [String] -&gt; [String]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; String -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;.mid&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(String -&gt; Bool) -&gt; ShowS -&gt; String -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ShowS
</span><span class="hs-identifier hs-var">takeExtension</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621679130108"><span class="hs-identifier hs-var">contents</span></a></span><span>
</span><span id="line-265"></span></pre></body></html>