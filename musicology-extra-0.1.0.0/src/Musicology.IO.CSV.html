<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts, DataKinds, TemplateHaskell #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-4"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Musicology.IO.CSV</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Frames</span></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Frames.TH</span></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Lens.Micro</span></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Lens.Micro.Extras</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">F</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Language.Haskell.TH</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">System.FilePath</span></span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Musicology.Core</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Mus</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">onset</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">offset</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">pitch</span></span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-comment">-- fn = &quot;/home/chfin/Uni/phd/data/midi_archive/notes/s/k555.tsv&quot;</span><span>
</span><span id="line-17"></span><span id="fn"><span class="annot"><span class="annottext">fn :: String
</span><a href="Musicology.IO.CSV.html#fn"><span class="hs-identifier hs-var hs-var">fn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="hs-keyword">do</span><span> </span><span id="local-6989586621679117362"><span class="annot"><a href="#local-6989586621679117362"><span class="hs-identifier hs-var">file</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="hs-identifier hs-var">loc_filename</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">location</span></span><span>
</span><span id="line-18"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">litE</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">stringL</span></span><span> </span><span class="annot"><span class="hs-operator hs-type">$</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">joinPath</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">takeDirectory</span></span><span> </span><span class="annot"><a href="#local-6989586621679117362"><span class="hs-identifier hs-type">file</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;..&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;..&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;..&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;res&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-string">&quot;midi.tsv&quot;</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span id="CsvOnset"><span id="CsvTrack"><span id="CsvChannel"><span id="CsvOffset"><span id="CsvPitch"><span id="CsvVelocity"><span id="local-6989586621679117128"><span id="local-6989586621679117129"><span id="local-6989586621679117132"><span id="local-6989586621679117133"><span id="local-6989586621679117134"><span id="local-6989586621679117135"><span id="local-6989586621679117136"><span id="local-6989586621679117137"><span id="local-6989586621679117138"><span id="local-6989586621679117139"><span id="local-6989586621679117140"><span id="local-6989586621679117141"><span id="local-6989586621679117142"><span id="local-6989586621679117143"><span id="local-6989586621679117144"><span id="local-6989586621679117145"><span id="local-6989586621679117146"><span id="local-6989586621679117147"><span id="local-6989586621679117148"><span id="local-6989586621679117149"><span id="local-6989586621679117150"><span id="local-6989586621679117151"><span id="local-6989586621679117152"><span id="local-6989586621679117153"><span id="local-6989586621679117154"><span id="local-6989586621679117155"><span id="local-6989586621679117156"><span id="local-6989586621679117157"><span id="local-6989586621679117158"><span id="local-6989586621679117159"><span id="CsvNote"><span id="csvNoteParser"><span id="csvTrack"><span id="csvTrack%27"><span id="csvChannel"><span id="csvChannel%27"><span id="csvOnset"><span id="csvOnset%27"><span id="csvOffset"><span id="csvOffset%27"><span id="csvPitch"><span id="csvPitch%27"><span id="csvVelocity"><span id="csvVelocity%27"><span class="hs-identifier">tableTypes'</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">rowGen</span><span>
</span><span id="line-21"></span><span>             </span><span class="hs-special">$</span><span class="hs-special">(</span><span class="hs-keyword">do</span><span> </span><span class="hs-identifier">file</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">loc_filename</span><span> </span><span class="hs-operator">&lt;$&gt;</span><span> </span><span class="hs-identifier">location</span><span>
</span><span id="line-22"></span><span>                  </span><span class="hs-identifier">litE</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">stringL</span><span> </span><span class="hs-operator">$</span><span> </span><span class="hs-identifier">joinPath</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-identifier">takeDirectory</span><span> </span><span class="hs-identifier">file</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;..&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;..&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;..&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;res&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;midi.tsv&quot;</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- relative to musicology-core/</span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-identifier">rowTypeName</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;CsvNote&quot;</span><span>
</span><span id="line-24"></span><span class="hs-comment">--  , columnNames = [&quot;Track&quot;, &quot;Channel&quot;, &quot;Onset&quot;, &quot;Offset&quot;, &quot;Pitch&quot;, &quot;Velocity&quot;]</span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">separator</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;\t&quot;</span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier">tablePrefix</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-string">&quot;csv&quot;</span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">}</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="annot"><a href="Musicology.IO.CSV.html#loadPiece"><span class="hs-identifier hs-type">loadPiece</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Frame</span></span><span> </span><span class="annot"><a href="Musicology.IO.CSV.html#CsvNote"><span class="hs-identifier hs-type">CsvNote</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span id="loadPiece"><span class="annot"><span class="annottext">loadPiece :: String -&gt; IO (Frame CsvNote)
</span><a href="Musicology.IO.CSV.html#loadPiece"><span class="hs-identifier hs-var hs-var">loadPiece</span></a></span></span><span> </span><span id="local-6989586621679117468"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679117468"><span class="hs-identifier hs-var">fp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Producer CsvNote (SafeT IO) () -&gt; IO (Frame CsvNote)
forall (m :: * -&gt; *) (rs :: [(Symbol, *)]).
(PrimMonad m, MonadIO m, MonadMask m, RecVec rs) =&gt;
Producer (Record rs) (SafeT m) () -&gt; m (FrameRec rs)
</span><span class="hs-identifier hs-var">inCoreAoS</span></span><span> </span><span class="annot"><span class="annottext">(Producer CsvNote (SafeT IO) () -&gt; IO (Frame CsvNote))
-&gt; Producer CsvNote (SafeT IO) () -&gt; IO (Frame CsvNote)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ParserOptions -&gt; String -&gt; Producer CsvNote (SafeT IO) ()
forall (m :: * -&gt; *) (rs :: [(Symbol, *)]).
(MonadSafe m, ReadRec rs, RMap rs) =&gt;
ParserOptions -&gt; String -&gt; Producer (Record rs) m ()
</span><span class="hs-identifier hs-var">readTableOpt</span></span><span> </span><span class="annot"><span class="annottext">ParserOptions
</span><a href="Musicology.IO.CSV.html#csvNoteParser"><span class="hs-identifier hs-var">csvNoteParser</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621679117468"><span class="hs-identifier hs-var">fp</span></a></span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span class="annot"><a href="Musicology.IO.CSV.html#frameNotes"><span class="hs-identifier hs-type">frameNotes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Frame</span></span><span> </span><span class="annot"><a href="Musicology.IO.CSV.html#CsvNote"><span class="hs-identifier hs-type">CsvNote</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Note</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">MidiInterval</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">]</span><span>
</span><span id="line-33"></span><span id="frameNotes"><span class="annot"><span class="annottext">frameNotes :: Frame CsvNote -&gt; [Note Int Int]
</span><a href="Musicology.IO.CSV.html#frameNotes"><span class="hs-identifier hs-var hs-var">frameNotes</span></a></span></span><span> </span><span id="local-6989586621679117473"><span class="annot"><span class="annottext">Frame CsvNote
</span><a href="#local-6989586621679117473"><span class="hs-identifier hs-var">fr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CsvNote -&gt; Note Int Int) -&gt; [CsvNote] -&gt; [Note Int Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">CsvNote -&gt; Note Int Int
forall {rs :: [(Symbol, *)]}.
(RecElem Rec CsvOnset CsvOnset rs rs (RIndex CsvOnset rs),
 RecElem Rec CsvOffset CsvOffset rs rs (RIndex CsvOffset rs),
 RecElem Rec CsvPitch CsvPitch rs rs (RIndex CsvPitch rs)) =&gt;
Record rs -&gt; Note Int Int
</span><a href="#local-6989586621679117474"><span class="hs-identifier hs-var">toNote</span></a></span><span> </span><span class="annot"><span class="annottext">([CsvNote] -&gt; [Note Int Int]) -&gt; [CsvNote] -&gt; [Note Int Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Frame CsvNote -&gt; [CsvNote]
forall a. Frame a -&gt; [a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">F.toList</span></span><span> </span><span class="annot"><span class="annottext">Frame CsvNote
</span><a href="#local-6989586621679117473"><span class="hs-identifier hs-var">fr</span></a></span><span>
</span><span id="line-34"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679117474"><span class="annot"><span class="annottext">toNote :: Record rs -&gt; Note Int Int
</span><a href="#local-6989586621679117474"><span class="hs-identifier hs-var hs-var">toNote</span></a></span></span><span> </span><span id="local-6989586621679117496"><span class="annot"><span class="annottext">Record rs
</span><a href="#local-6989586621679117496"><span class="hs-identifier hs-var">row</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pitch Int -&gt; Int -&gt; Int -&gt; Note Int Int
forall p t. Pitch p -&gt; t -&gt; t -&gt; Note p t
</span><span class="hs-identifier hs-var">Note</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Pitch Int
forall {a}. a -&gt; Pitch a
</span><span class="hs-identifier hs-var">toPitch</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Pitch Int) -&gt; Int -&gt; Pitch Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Getting Int (Record rs) Int -&gt; Record rs -&gt; Int
forall a s. Getting a s a -&gt; s -&gt; a
</span><span class="hs-identifier hs-var">view</span></span><span> </span><span class="annot"><span class="annottext">Getting Int (Record rs) Int
forall (f :: * -&gt; *) (rs :: [(Symbol, *)]).
(Functor f, RElem CsvPitch rs (RIndex CsvPitch rs)) =&gt;
(Int -&gt; f Int) -&gt; Record rs -&gt; f (Record rs)
</span><a href="Musicology.IO.CSV.html#csvPitch"><span class="hs-identifier hs-var">csvPitch</span></a></span><span> </span><span class="annot"><span class="annottext">Record rs
</span><a href="#local-6989586621679117496"><span class="hs-identifier hs-var">row</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Getting Int (Record rs) Int -&gt; Record rs -&gt; Int
forall a s. Getting a s a -&gt; s -&gt; a
</span><span class="hs-identifier hs-var">view</span></span><span> </span><span class="annot"><span class="annottext">Getting Int (Record rs) Int
forall (f :: * -&gt; *) (rs :: [(Symbol, *)]).
(Functor f, RElem CsvOnset rs (RIndex CsvOnset rs)) =&gt;
(Int -&gt; f Int) -&gt; Record rs -&gt; f (Record rs)
</span><a href="Musicology.IO.CSV.html#csvOnset"><span class="hs-identifier hs-var">csvOnset</span></a></span><span> </span><span class="annot"><span class="annottext">Record rs
</span><a href="#local-6989586621679117496"><span class="hs-identifier hs-var">row</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Getting Int (Record rs) Int -&gt; Record rs -&gt; Int
forall a s. Getting a s a -&gt; s -&gt; a
</span><span class="hs-identifier hs-var">view</span></span><span> </span><span class="annot"><span class="annottext">Getting Int (Record rs) Int
forall (f :: * -&gt; *) (rs :: [(Symbol, *)]).
(Functor f, RElem CsvOffset rs (RIndex CsvOffset rs)) =&gt;
(Int -&gt; f Int) -&gt; Record rs -&gt; f (Record rs)
</span><a href="Musicology.IO.CSV.html#csvOffset"><span class="hs-identifier hs-var">csvOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Record rs
</span><a href="#local-6989586621679117496"><span class="hs-identifier hs-var">row</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span></pre></body></html>