<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE Arrows, ScopedTypeVariables, NamedFieldPuns, FlexibleContexts #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-comment">-- Render a Music object to a audio signal function that can be further</span><span>
</span><span id="line-4"></span><span class="hs-comment">-- manipulated or saved to a file.  It is channel-agnostic in that it is</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- able to deal with instruments of arbitrary number of channels.</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Euterpea.IO.Audio.Render</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-8"></span><span>  </span><span class="annot"><a href="Euterpea.IO.Audio.Render.html#Instr"><span class="hs-identifier">Instr</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Euterpea.IO.Audio.Render.html#InstrMap"><span class="hs-identifier">InstrMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Euterpea.IO.Audio.Render.html#renderSF"><span class="hs-identifier">renderSF</span></a></span><span class="hs-special">,</span><span> </span><span>
</span><span id="line-9"></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Arrow</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Arrow.Operations</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.Arrow.ArrowP.html"><span class="hs-identifier">Control.Arrow.ArrowP</span></a></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Control.SF.SF.html"><span class="hs-identifier">Control.SF.SF</span></a></span><span>
</span><span id="line-15"></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Euterpea.Music.html"><span class="hs-identifier">Euterpea.Music</span></a></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Euterpea.IO.MIDI.MEvent.html"><span class="hs-identifier">Euterpea.IO.MIDI.MEvent</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Euterpea.IO.Audio.Basics.html"><span class="hs-identifier">Euterpea.IO.Audio.Basics</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Euterpea.IO.Audio.Types.html"><span class="hs-identifier">Euterpea.IO.Audio.Types</span></a></span><span>
</span><span id="line-20"></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.IntMap</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Ord</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">comparing</span></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span class="hs-comment">-- Every instrument is a function that takes a duration, absolute</span><span>
</span><span id="line-26"></span><span class="hs-comment">-- pitch, volume, and a list of parameters (Doubles).  What the function </span><span>
</span><span id="line-27"></span><span class="hs-comment">-- actually returns is implementation independent.</span><span>
</span><span id="line-28"></span><span class="hs-keyword">type</span><span> </span><span id="Instr"><span class="annot"><a href="Euterpea.IO.Audio.Render.html#Instr"><span class="hs-identifier hs-var">Instr</span></a></span></span><span> </span><span id="local-6989586621679105541"><span class="annot"><a href="#local-6989586621679105541"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Euterpea.Music.html#Dur"><span class="hs-identifier hs-type">Dur</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Euterpea.Music.html#AbsPitch"><span class="hs-identifier hs-type">AbsPitch</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Euterpea.Music.html#Volume"><span class="hs-identifier hs-type">Volume</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679105541"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span class="hs-keyword">type</span><span> </span><span id="InstrMap"><span class="annot"><a href="Euterpea.IO.Audio.Render.html#InstrMap"><span class="hs-identifier hs-var">InstrMap</span></a></span></span><span> </span><span id="local-6989586621679105545"><span class="annot"><a href="#local-6989586621679105545"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Euterpea.Music.html#InstrumentName"><span class="hs-identifier hs-type">InstrumentName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Euterpea.IO.Audio.Render.html#Instr"><span class="hs-identifier hs-type">Instr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105545"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span id="local-6989586621679105422"><span class="annot"><a href="Euterpea.IO.Audio.Render.html#lookupInstr"><span class="hs-identifier hs-type">lookupInstr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Euterpea.Music.html#InstrumentName"><span class="hs-identifier hs-type">InstrumentName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Euterpea.IO.Audio.Render.html#InstrMap"><span class="hs-identifier hs-type">InstrMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105422"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Euterpea.IO.Audio.Render.html#Instr"><span class="hs-identifier hs-type">Instr</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105422"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-33"></span><span id="lookupInstr"><span class="annot"><span class="annottext">lookupInstr :: forall a. InstrumentName -&gt; InstrMap a -&gt; Instr a
</span><a href="Euterpea.IO.Audio.Render.html#lookupInstr"><span class="hs-identifier hs-var hs-var">lookupInstr</span></a></span></span><span> </span><span id="local-6989586621679105553"><span class="annot"><span class="annottext">InstrumentName
</span><a href="#local-6989586621679105553"><span class="hs-identifier hs-var">ins</span></a></span></span><span> </span><span id="local-6989586621679105554"><span class="annot"><span class="annottext">InstrMap a
</span><a href="#local-6989586621679105554"><span class="hs-identifier hs-var">im</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-34"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">InstrumentName -&gt; InstrMap a -&gt; Maybe (Instr a)
forall a b. Eq a =&gt; a -&gt; [(a, b)] -&gt; Maybe b
</span><span class="hs-identifier hs-var">lookup</span></span><span> </span><span class="annot"><span class="annottext">InstrumentName
</span><a href="#local-6989586621679105553"><span class="hs-identifier hs-var">ins</span></a></span><span> </span><span class="annot"><span class="annottext">InstrMap a
</span><a href="#local-6989586621679105554"><span class="hs-identifier hs-var">im</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-35"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679105556"><span class="annot"><span class="annottext">Instr a
</span><a href="#local-6989586621679105556"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Instr a
</span><a href="#local-6989586621679105556"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-36"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Instr a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Instr a
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; Instr a) -&gt; [Char] -&gt; Instr a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Instrument &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">InstrumentName -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">InstrumentName
</span><a href="#local-6989586621679105553"><span class="hs-identifier hs-var">ins</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span>
</span><span id="line-37"></span><span>                 </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; does not have a matching Instr in the supplied InstrMap.&quot;</span></span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span class="hs-comment">-- Each note in a Performance is tagged with a unique NoteId, which</span><span>
</span><span id="line-40"></span><span class="hs-comment">-- helps us keep track of the signal function associated with a note.</span><span>
</span><span id="line-41"></span><span class="hs-keyword">type</span><span> </span><span id="NoteId"><span class="annot"><a href="Euterpea.IO.Audio.Render.html#NoteId"><span class="hs-identifier hs-var">NoteId</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-42"></span><span>
</span><span id="line-43"></span><span class="hs-comment">-- In this particular implementation, 'a' is the signal function that</span><span>
</span><span id="line-44"></span><span class="hs-comment">-- plays the given note.</span><span>
</span><span id="line-45"></span><span class="hs-keyword">data</span><span> </span><span id="NoteEvt"><span class="annot"><a href="Euterpea.IO.Audio.Render.html#NoteEvt"><span class="hs-identifier hs-var">NoteEvt</span></a></span></span><span> </span><span id="local-6989586621679105443"><span class="annot"><a href="#local-6989586621679105443"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="NoteOn"><span class="annot"><a href="Euterpea.IO.Audio.Render.html#NoteOn"><span class="hs-identifier hs-var">NoteOn</span></a></span></span><span>  </span><span class="annot"><a href="Euterpea.IO.Audio.Render.html#NoteId"><span class="hs-identifier hs-type">NoteId</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105443"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-46"></span><span>               </span><span class="hs-glyph">|</span><span> </span><span id="NoteOff"><span class="annot"><a href="Euterpea.IO.Audio.Render.html#NoteOff"><span class="hs-identifier hs-var">NoteOff</span></a></span></span><span> </span><span class="annot"><a href="Euterpea.IO.Audio.Render.html#NoteId"><span class="hs-identifier hs-type">NoteId</span></a></span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="hs-keyword">type</span><span> </span><span id="Evt"><span class="annot"><a href="Euterpea.IO.Audio.Render.html#Evt"><span class="hs-identifier hs-var">Evt</span></a></span></span><span> </span><span id="local-6989586621679105562"><span class="annot"><a href="#local-6989586621679105562"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Euterpea.IO.Audio.Render.html#NoteEvt"><span class="hs-identifier hs-type">NoteEvt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105562"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Timestamp in seconds, and the note event</span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span class="hs-comment">-- Turn an Event into a NoteOn and a matching NoteOff with the same NodeId.  </span><span>
</span><span id="line-52"></span><span id="local-6989586621679105436"><span class="annot"><a href="Euterpea.IO.Audio.Render.html#eventToEvtPair"><span class="hs-identifier hs-type">eventToEvtPair</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Euterpea.IO.Audio.Render.html#InstrMap"><span class="hs-identifier hs-type">InstrMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105436"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Euterpea.IO.MIDI.MEvent.html#MEvent"><span class="hs-identifier hs-type">MEvent</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Euterpea.IO.Audio.Render.html#Evt"><span class="hs-identifier hs-type">Evt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105436"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-53"></span><span id="eventToEvtPair"><span class="annot"><span class="annottext">eventToEvtPair :: forall a. InstrMap a -&gt; MEvent -&gt; Int -&gt; [Evt a]
</span><a href="Euterpea.IO.Audio.Render.html#eventToEvtPair"><span class="hs-identifier hs-var hs-var">eventToEvtPair</span></a></span></span><span> </span><span id="local-6989586621679105566"><span class="annot"><span class="annottext">InstrMap a
</span><a href="#local-6989586621679105566"><span class="hs-identifier hs-var">imap</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Euterpea.IO.MIDI.MEvent.html#MEvent"><span class="hs-identifier hs-type">MEvent</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621679105568"><span class="annot"><span class="annottext">PTime
eTime :: PTime
eTime :: MEvent -&gt; PTime
</span><a href="#local-6989586621679105568"><span class="hs-identifier hs-var hs-var">eTime</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679105570"><span class="annot"><span class="annottext">InstrumentName
eInst :: InstrumentName
eInst :: MEvent -&gt; InstrumentName
</span><a href="#local-6989586621679105570"><span class="hs-identifier hs-var hs-var">eInst</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679105572"><span class="annot"><span class="annottext">Int
ePitch :: Int
ePitch :: MEvent -&gt; Int
</span><a href="#local-6989586621679105572"><span class="hs-identifier hs-var hs-var">ePitch</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679105574"><span class="annot"><span class="annottext">PTime
eDur :: PTime
eDur :: MEvent -&gt; PTime
</span><a href="#local-6989586621679105574"><span class="hs-identifier hs-var hs-var">eDur</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679105576"><span class="annot"><span class="annottext">Int
eVol :: Int
eVol :: MEvent -&gt; Int
</span><a href="#local-6989586621679105576"><span class="hs-identifier hs-var hs-var">eVol</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679105578"><span class="annot"><span class="annottext">[Double]
eParams :: [Double]
eParams :: MEvent -&gt; [Double]
</span><a href="#local-6989586621679105578"><span class="hs-identifier hs-var hs-var">eParams</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679105580"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679105580"><span class="hs-identifier hs-var">nid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-54"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679105581"><span class="annot"><span class="annottext">instr :: Instr a
</span><a href="#local-6989586621679105581"><span class="hs-identifier hs-var hs-var">instr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InstrumentName -&gt; InstrMap a -&gt; Instr a
forall a. InstrumentName -&gt; InstrMap a -&gt; Instr a
</span><a href="Euterpea.IO.Audio.Render.html#lookupInstr"><span class="hs-identifier hs-var">lookupInstr</span></a></span><span> </span><span class="annot"><span class="annottext">InstrumentName
</span><a href="#local-6989586621679105570"><span class="hs-identifier hs-var">eInst</span></a></span><span> </span><span class="annot"><span class="annottext">InstrMap a
</span><a href="#local-6989586621679105566"><span class="hs-identifier hs-var">imap</span></a></span><span>
</span><span id="line-55"></span><span>        </span><span id="local-6989586621679105585"><span class="annot"><span class="annottext">tOn :: Double
</span><a href="#local-6989586621679105585"><span class="hs-identifier hs-var hs-var">tOn</span></a></span></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PTime -&gt; Double
forall a. Fractional a =&gt; PTime -&gt; a
</span><span class="hs-identifier hs-var">fromRational</span></span><span> </span><span class="annot"><span class="annottext">PTime
</span><a href="#local-6989586621679105568"><span class="hs-identifier hs-var">eTime</span></a></span><span>
</span><span id="line-56"></span><span>        </span><span id="local-6989586621679105587"><span class="annot"><span class="annottext">tDur :: Double
</span><a href="#local-6989586621679105587"><span class="hs-identifier hs-var hs-var">tDur</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PTime -&gt; Double
forall a. Fractional a =&gt; PTime -&gt; a
</span><span class="hs-identifier hs-var">fromRational</span></span><span> </span><span class="annot"><span class="annottext">PTime
</span><a href="#local-6989586621679105574"><span class="hs-identifier hs-var">eDur</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span>
</span><span id="line-57"></span><span>        </span><span id="local-6989586621679105588"><span class="annot"><span class="annottext">sf :: a
</span><a href="#local-6989586621679105588"><span class="hs-identifier hs-var hs-var">sf</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Instr a
</span><a href="#local-6989586621679105581"><span class="hs-identifier hs-var">instr</span></a></span><span> </span><span class="annot"><span class="annottext">PTime
</span><a href="#local-6989586621679105574"><span class="hs-identifier hs-var">eDur</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679105572"><span class="hs-identifier hs-var">ePitch</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679105576"><span class="hs-identifier hs-var">eVol</span></a></span><span> </span><span class="annot"><span class="annottext">[Double]
</span><a href="#local-6989586621679105578"><span class="hs-identifier hs-var">eParams</span></a></span><span>
</span><span id="line-58"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679105585"><span class="hs-identifier hs-var">tOn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; a -&gt; NoteEvt a
forall a. Int -&gt; a -&gt; NoteEvt a
</span><a href="Euterpea.IO.Audio.Render.html#NoteOn"><span class="hs-identifier hs-var">NoteOn</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679105580"><span class="hs-identifier hs-var">nid</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679105588"><span class="hs-identifier hs-var">sf</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679105585"><span class="hs-identifier hs-var">tOn</span></a></span><span> </span><span class="annot"><span class="annottext">Double -&gt; Double -&gt; Double
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679105587"><span class="hs-identifier hs-var">tDur</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; NoteEvt a
forall a. Int -&gt; NoteEvt a
</span><a href="Euterpea.IO.Audio.Render.html#NoteOff"><span class="hs-identifier hs-var">NoteOff</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679105580"><span class="hs-identifier hs-var">nid</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-comment">-- Turn a Performance into an SF of NoteOn/NoteOffs.  </span><span>
</span><span id="line-61"></span><span class="hs-comment">-- For each note, generate a unique id to tag the NoteOn and NoteOffs.</span><span>
</span><span id="line-62"></span><span class="hs-comment">-- The tag is used as the key to the collection of signal functions</span><span>
</span><span id="line-63"></span><span class="hs-comment">-- for efficient insertion/removal.</span><span>
</span><span id="line-64"></span><span id="local-6989586621679105445"><span id="local-6989586621679105447"><span class="annot"><a href="Euterpea.IO.Audio.Render.html#toEvtSF"><span class="hs-identifier hs-type">toEvtSF</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Euterpea.IO.Audio.Types.html#Clock"><span class="hs-identifier hs-type">Clock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105445"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Euterpea.IO.MIDI.MEvent.html#MEvent"><span class="hs-identifier hs-type">MEvent</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Euterpea.IO.Audio.Render.html#InstrMap"><span class="hs-identifier hs-type">InstrMap</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105447"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Euterpea.IO.Audio.Types.html#Signal"><span class="hs-identifier hs-type">Signal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105445"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Euterpea.IO.Audio.Render.html#Evt"><span class="hs-identifier hs-type">Evt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105447"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span></span></span><span>
</span><span id="line-65"></span><span id="toEvtSF"><span class="annot"><span class="annottext">toEvtSF :: forall p a.
Clock p =&gt;
[MEvent] -&gt; InstrMap a -&gt; Signal p () [Evt a]
</span><a href="Euterpea.IO.Audio.Render.html#toEvtSF"><span class="hs-identifier hs-var hs-var">toEvtSF</span></a></span></span><span> </span><span id="local-6989586621679105609"><span class="annot"><span class="annottext">[MEvent]
</span><a href="#local-6989586621679105609"><span class="hs-identifier hs-var">pf</span></a></span></span><span> </span><span id="local-6989586621679105610"><span class="annot"><span class="annottext">InstrMap a
</span><a href="#local-6989586621679105610"><span class="hs-identifier hs-var">imap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><span id="line-66"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679105619"><span class="annot"><span class="annottext">evts :: [Evt a]
</span><a href="#local-6989586621679105619"><span class="hs-identifier hs-var hs-var">evts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Evt a -&gt; Evt a -&gt; Ordering) -&gt; [Evt a] -&gt; [Evt a]
forall a. (a -&gt; a -&gt; Ordering) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sortBy</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Evt a -&gt; Double) -&gt; Evt a -&gt; Evt a -&gt; Ordering
forall a b. Ord a =&gt; (b -&gt; a) -&gt; b -&gt; b -&gt; Ordering
</span><span class="hs-identifier hs-var">comparing</span></span><span> </span><span class="annot"><span class="annottext">Evt a -&gt; Double
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Evt a] -&gt; [Evt a]) -&gt; [Evt a] -&gt; [Evt a]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[[Evt a]] -&gt; [Evt a]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">([[Evt a]] -&gt; [Evt a]) -&gt; [[Evt a]] -&gt; [Evt a]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span>
</span><span id="line-67"></span><span>                 </span><span class="annot"><span class="annottext">(MEvent -&gt; Int -&gt; [Evt a]) -&gt; [MEvent] -&gt; [Int] -&gt; [[Evt a]]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InstrMap a -&gt; MEvent -&gt; Int -&gt; [Evt a]
forall a. InstrMap a -&gt; MEvent -&gt; Int -&gt; [Evt a]
</span><a href="Euterpea.IO.Audio.Render.html#eventToEvtPair"><span class="hs-identifier hs-var">eventToEvtPair</span></a></span><span> </span><span class="annot"><span class="annottext">InstrMap a
</span><a href="#local-6989586621679105610"><span class="hs-identifier hs-var">imap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[MEvent]
</span><a href="#local-6989586621679105609"><span class="hs-identifier hs-var">pf</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><span id="line-68"></span><span>          </span><span class="hs-comment">-- Sort all NoteOn/NoteOff events by timestamp.</span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">proc</span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-70"></span><span>         </span><span class="hs-keyword">rec</span><span>
</span><span id="line-71"></span><span>           </span><span id="local-6989586621679105624"><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679105624"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ArrowP SF p Double Double
forall (a :: * -&gt; * -&gt; *) p.
(ArrowCircuit a, Clock p) =&gt;
ArrowP a p Double Double
</span><a href="Euterpea.IO.Audio.Basics.html#integral"><span class="hs-identifier hs-var">integral</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">Double
</span><span class="hs-number">1</span></span><span>
</span><span id="line-72"></span><span>           </span><span id="local-6989586621679105626"><span class="annot"><span class="annottext">[Evt a]
</span><a href="#local-6989586621679105626"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Evt a] -&gt; ArrowP SF p [Evt a] [Evt a]
forall b. b -&gt; ArrowP SF p b b
forall (a :: * -&gt; * -&gt; *) b. ArrowCircuit a =&gt; b -&gt; a b b
</span><span class="hs-identifier hs-var">delay</span></span><span> </span><span class="annot"><span class="annottext">[Evt a]
</span><a href="#local-6989586621679105619"><span class="hs-identifier hs-var">evts</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">[Evt a]
</span><a href="#local-6989586621679105628"><span class="hs-identifier hs-var">next</span></a></span><span>
</span><span id="line-73"></span><span>           </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679105630"><span class="annot"><span class="annottext">[Evt a]
</span><a href="#local-6989586621679105630"><span class="hs-identifier hs-var">evs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679105628"><span class="annot"><span class="annottext">[Evt a]
</span><a href="#local-6989586621679105628"><span class="hs-identifier hs-var">next</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Evt a -&gt; Bool) -&gt; [Evt a] -&gt; ([Evt a], [Evt a])
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">span</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Double -&gt; Double -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Double
</span><a href="#local-6989586621679105624"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Double -&gt; Bool) -&gt; (Evt a -&gt; Double) -&gt; Evt a -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Evt a -&gt; Double
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Evt a]
</span><a href="#local-6989586621679105626"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-74"></span><span>             </span><span class="hs-comment">-- Trim events that are due off the list and output them,</span><span>
</span><span id="line-75"></span><span>             </span><span class="hs-comment">-- retaining the rest</span><span>
</span><span id="line-76"></span><span>         </span><span class="annot"><span class="annottext">ArrowP SF p [Evt a] [Evt a]
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><a href="Euterpea.IO.Audio.Basics.html#outA"><span class="hs-identifier hs-var">outA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">[Evt a]
</span><a href="#local-6989586621679105630"><span class="hs-identifier hs-var">evs</span></a></span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span class="hs-comment">-- Modify the collection upon receiving NoteEvts.  The timestamps </span><span>
</span><span id="line-79"></span><span class="hs-comment">-- are not used here, but they are expected to be the same.</span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span id="local-6989586621679105483"><span class="annot"><a href="Euterpea.IO.Audio.Render.html#modSF"><span class="hs-identifier hs-type">modSF</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.IntMap</span></span><span> </span><span class="annot"><a href="#local-6989586621679105483"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Euterpea.IO.Audio.Render.html#Evt"><span class="hs-identifier hs-type">Evt</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105483"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.IntMap</span></span><span> </span><span class="annot"><a href="#local-6989586621679105483"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-82"></span><span id="modSF"><span class="annot"><span class="annottext">modSF :: forall a. IntMap a -&gt; [Evt a] -&gt; IntMap a
</span><a href="Euterpea.IO.Audio.Render.html#modSF"><span class="hs-identifier hs-var hs-var">modSF</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IntMap a -&gt; Evt a -&gt; IntMap a) -&gt; IntMap a -&gt; [Evt a] -&gt; IntMap a
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">IntMap a -&gt; Evt a -&gt; IntMap a
forall {a} {a}. IntMap a -&gt; (a, NoteEvt a) -&gt; IntMap a
</span><a href="#local-6989586621679105638"><span class="hs-identifier hs-var">mod</span></a></span><span>
</span><span id="line-83"></span><span>    </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679105638"><span class="annot"><span class="annottext">mod :: IntMap a -&gt; (a, NoteEvt a) -&gt; IntMap a
</span><a href="#local-6989586621679105638"><span class="hs-identifier hs-var hs-var">mod</span></a></span></span><span> </span><span id="local-6989586621679105639"><span class="annot"><span class="annottext">IntMap a
</span><a href="#local-6989586621679105639"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Euterpea.IO.Audio.Render.html#NoteOn"><span class="hs-identifier hs-type">NoteOn</span></a></span><span> </span><span id="local-6989586621679105640"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679105640"><span class="hs-identifier hs-var">nid</span></a></span></span><span> </span><span id="local-6989586621679105641"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679105641"><span class="hs-identifier hs-var">sf</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; a -&gt; IntMap a -&gt; IntMap a
forall a. Int -&gt; a -&gt; IntMap a -&gt; IntMap a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679105640"><span class="hs-identifier hs-var">nid</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621679105641"><span class="hs-identifier hs-var">sf</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap a
</span><a href="#local-6989586621679105639"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-84"></span><span>          </span><span class="annot"><a href="#local-6989586621679105638"><span class="hs-identifier hs-var">mod</span></a></span><span> </span><span id="local-6989586621679105643"><span class="annot"><span class="annottext">IntMap a
</span><a href="#local-6989586621679105643"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Euterpea.IO.Audio.Render.html#NoteOff"><span class="hs-identifier hs-type">NoteOff</span></a></span><span> </span><span id="local-6989586621679105644"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679105644"><span class="hs-identifier hs-var">nid</span></a></span></span><span class="hs-special">)</span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; IntMap a -&gt; IntMap a
forall a. Int -&gt; IntMap a -&gt; IntMap a
</span><span class="hs-identifier hs-var">M.delete</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679105644"><span class="hs-identifier hs-var">nid</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap a
</span><a href="#local-6989586621679105643"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="hs-comment">-- Simplified version of a parallel switcher.  </span><span>
</span><span id="line-88"></span><span class="hs-comment">-- Note that this is tied to the particular implementation of SF, as it</span><span>
</span><span id="line-89"></span><span class="hs-comment">-- needs to use runSF to run all the signal functions in the collection.</span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="annot"><a href="Euterpea.IO.Audio.Render.html#pSwitch"><span class="hs-identifier hs-type">pSwitch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679105493"><span class="annot"><a href="#local-6989586621679105493"><span class="hs-identifier hs-type">p</span></a></span></span><span> </span><span id="local-6989586621679105494"><span class="annot"><a href="#local-6989586621679105494"><span class="hs-identifier hs-type">col</span></a></span></span><span> </span><span id="local-6989586621679105495"><span class="annot"><a href="#local-6989586621679105495"><span class="hs-identifier hs-type">a</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Euterpea.IO.Audio.Types.html#Clock"><span class="hs-identifier hs-type">Clock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105493"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Functor</span></span><span> </span><span class="annot"><a href="#local-6989586621679105494"><span class="hs-identifier hs-type">col</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-92"></span><span>           </span><span class="annot"><a href="#local-6989586621679105494"><span class="hs-identifier hs-type">col</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Euterpea.IO.Audio.Types.html#Signal"><span class="hs-identifier hs-type">Signal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105493"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679105495"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- Initial SF collection.</span><span>
</span><span id="line-93"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Euterpea.IO.Audio.Types.html#Signal"><span class="hs-identifier hs-type">Signal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105493"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Euterpea.IO.Audio.Render.html#Evt"><span class="hs-identifier hs-type">Evt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Euterpea.IO.Audio.Types.html#Signal"><span class="hs-identifier hs-type">Signal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105493"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679105495"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>    </span><span class="hs-comment">-- Input event stream.</span><span>
</span><span id="line-94"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679105494"><span class="hs-identifier hs-type">col</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Euterpea.IO.Audio.Types.html#Signal"><span class="hs-identifier hs-type">Signal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105493"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679105495"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Euterpea.IO.Audio.Render.html#Evt"><span class="hs-identifier hs-type">Evt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Euterpea.IO.Audio.Types.html#Signal"><span class="hs-identifier hs-type">Signal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105493"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679105495"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679105494"><span class="hs-identifier hs-type">col</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Euterpea.IO.Audio.Types.html#Signal"><span class="hs-identifier hs-type">Signal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105493"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679105495"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span>           </span><span class="hs-comment">-- A Modifying function that modifies the collection of SF</span><span>
</span><span id="line-96"></span><span>           </span><span class="hs-comment">--   based on the event that is occuring.</span><span>
</span><span id="line-97"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Euterpea.IO.Audio.Types.html#Signal"><span class="hs-identifier hs-type">Signal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105493"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679105494"><span class="hs-identifier hs-type">col</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105495"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>  </span><span>
</span><span id="line-98"></span><span>           </span><span class="hs-comment">-- The resulting collection of output values obtained from</span><span>
</span><span id="line-99"></span><span>           </span><span class="hs-comment">--   running all SFs in the collection.</span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span id="pSwitch"><span class="annot"><span class="annottext">pSwitch :: forall p (col :: * -&gt; *) a.
(Clock p, Functor col) =&gt;
col (Signal p () a)
-&gt; Signal p () [Evt (Signal p () a)]
-&gt; (col (Signal p () a)
    -&gt; [Evt (Signal p () a)] -&gt; col (Signal p () a))
-&gt; Signal p () (col a)
</span><a href="Euterpea.IO.Audio.Render.html#pSwitch"><span class="hs-identifier hs-var hs-var">pSwitch</span></a></span></span><span> </span><span id="local-6989586621679105658"><span class="annot"><span class="annottext">col (Signal p () a)
</span><a href="#local-6989586621679105658"><span class="hs-identifier hs-var">col</span></a></span></span><span> </span><span id="local-6989586621679105659"><span class="annot"><span class="annottext">Signal p () [Evt (Signal p () a)]
</span><a href="#local-6989586621679105659"><span class="hs-identifier hs-var">esig</span></a></span></span><span> </span><span id="local-6989586621679105660"><span class="annot"><span class="annottext">col (Signal p () a) -&gt; [Evt (Signal p () a)] -&gt; col (Signal p () a)
</span><a href="#local-6989586621679105660"><span class="hs-identifier hs-var">mod</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-keyword">proc</span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-103"></span><span>      </span><span id="local-6989586621679105661"><span class="annot"><span class="annottext">[Evt (Signal p () a)]
</span><a href="#local-6989586621679105661"><span class="hs-identifier hs-var">evts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Signal p () [Evt (Signal p () a)]
</span><a href="#local-6989586621679105659"><span class="hs-identifier hs-var">esig</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-104"></span><span>      </span><span class="hs-keyword">rec</span><span>
</span><span id="line-105"></span><span>        </span><span class="hs-comment">-- perhaps this can be run at a lower rate using upsample</span><span>
</span><span id="line-106"></span><span>        </span><span id="local-6989586621679105662"><span class="annot"><span class="annottext">col (Signal p () a)
</span><a href="#local-6989586621679105662"><span class="hs-identifier hs-var">sfcol</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">col (Signal p () a)
-&gt; ArrowP SF p (col (Signal p () a)) (col (Signal p () a))
forall b. b -&gt; ArrowP SF p b b
forall (a :: * -&gt; * -&gt; *) b. ArrowCircuit a =&gt; b -&gt; a b b
</span><span class="hs-identifier hs-var">delay</span></span><span> </span><span class="annot"><span class="annottext">col (Signal p () a)
</span><a href="#local-6989586621679105658"><span class="hs-identifier hs-var">col</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">col (Signal p () a) -&gt; [Evt (Signal p () a)] -&gt; col (Signal p () a)
</span><a href="#local-6989586621679105660"><span class="hs-identifier hs-var">mod</span></a></span><span> </span><span class="annot"><span class="annottext">col (Signal p () a)
</span><a href="#local-6989586621679105663"><span class="hs-identifier hs-var">sfcol'</span></a></span><span> </span><span class="annot"><span class="annottext">[Evt (Signal p () a)]
</span><a href="#local-6989586621679105661"><span class="hs-identifier hs-var">evts</span></a></span><span>  </span><span>
</span><span id="line-107"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679105665"><span class="annot"><span class="annottext">rs :: col (a, SF () a)
</span><a href="#local-6989586621679105665"><span class="hs-identifier hs-var hs-var">rs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Signal p () a -&gt; (a, SF () a))
-&gt; col (Signal p () a) -&gt; col (a, SF () a)
forall a b. (a -&gt; b) -&gt; col a -&gt; col b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679105666"><span class="annot"><span class="annottext">Signal p () a
</span><a href="#local-6989586621679105666"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SF () a -&gt; () -&gt; (a, SF () a)
forall a b. SF a b -&gt; a -&gt; (b, SF a b)
</span><a href="Control.SF.SF.html#runSF"><span class="hs-identifier hs-var">runSF</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Signal p () a -&gt; SF () a
forall (a :: * -&gt; * -&gt; *) p b c. ArrowP a p b c -&gt; a b c
</span><a href="Control.Arrow.ArrowP.html#strip"><span class="hs-identifier hs-var">strip</span></a></span><span> </span><span class="annot"><span class="annottext">Signal p () a
</span><a href="#local-6989586621679105666"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">col (Signal p () a)
</span><a href="#local-6989586621679105662"><span class="hs-identifier hs-var">sfcol</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679105494"><span class="hs-identifier hs-type">col</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679105495"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Control.SF.SF.html#SF"><span class="hs-identifier hs-type">SF</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679105495"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621679105671"><span class="annot"><span class="annottext">col a
</span><a href="#local-6989586621679105671"><span class="hs-keyword hs-var">as</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679105663"><span class="annot"><span class="annottext">col (Signal p () a)
</span><a href="#local-6989586621679105663"><span class="hs-identifier hs-var">sfcol'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679105494"><span class="hs-identifier hs-type">col</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Euterpea.IO.Audio.Types.html#Signal"><span class="hs-identifier hs-type">Signal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105493"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679105495"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((a, SF () a) -&gt; a) -&gt; col (a, SF () a) -&gt; col a
forall a b. (a -&gt; b) -&gt; col a -&gt; col b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(a, SF () a) -&gt; a
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">col (a, SF () a)
</span><a href="#local-6989586621679105665"><span class="hs-identifier hs-var">rs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">((a, SF () a) -&gt; Signal p () a)
-&gt; col (a, SF () a) -&gt; col (Signal p () a)
forall a b. (a -&gt; b) -&gt; col a -&gt; col b
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SF () a -&gt; Signal p () a
forall (a :: * -&gt; * -&gt; *) p b c. a b c -&gt; ArrowP a p b c
</span><a href="Control.Arrow.ArrowP.html#ArrowP"><span class="hs-identifier hs-var">ArrowP</span></a></span><span> </span><span class="annot"><span class="annottext">(SF () a -&gt; Signal p () a)
-&gt; ((a, SF () a) -&gt; SF () a) -&gt; (a, SF () a) -&gt; Signal p () a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(a, SF () a) -&gt; SF () a
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">col (a, SF () a)
</span><a href="#local-6989586621679105665"><span class="hs-identifier hs-var">rs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span>      </span><span class="annot"><span class="annottext">ArrowP SF p (col a) (col a)
forall (a :: * -&gt; * -&gt; *) b. Arrow a =&gt; a b b
</span><a href="Euterpea.IO.Audio.Basics.html#outA"><span class="hs-identifier hs-var">outA</span></a></span><span> </span><span class="hs-glyph">-&lt;</span><span> </span><span class="annot"><span class="annottext">col a
</span><a href="#local-6989586621679105671"><span class="hs-keyword hs-var">as</span></a></span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span id="local-6989586621679105514"><span id="local-6989586621679105515"><span id="local-6989586621679105517"><span class="annot"><a href="Euterpea.IO.Audio.Render.html#renderSF"><span class="hs-identifier hs-type">renderSF</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Euterpea.IO.Audio.Types.html#Clock"><span class="hs-identifier hs-type">Clock</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105514"><span class="hs-identifier hs-type">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Euterpea.Music.html#ToMusic1"><span class="hs-identifier hs-type">ToMusic1</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105515"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Euterpea.IO.Audio.Types.html#AudioSample"><span class="hs-identifier hs-type">AudioSample</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105517"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span>
</span><span id="line-113"></span><span>            </span><span class="annot"><a href="Euterpea.Music.html#Music"><span class="hs-identifier hs-type">Music</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105515"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span>
</span><span id="line-114"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Euterpea.IO.Audio.Render.html#InstrMap"><span class="hs-identifier hs-type">InstrMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Euterpea.IO.Audio.Types.html#Signal"><span class="hs-identifier hs-type">Signal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105514"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679105517"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span>
</span><span id="line-115"></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Double</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Euterpea.IO.Audio.Types.html#Signal"><span class="hs-identifier hs-type">Signal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679105514"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679105517"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-116"></span><span>            </span><span class="hs-comment">-- ^ Duration of the music in seconds, </span><span>
</span><span id="line-117"></span><span>            </span><span class="hs-comment">-- and a signal function that plays the music.</span><span>
</span><span id="line-118"></span><span>
</span><span id="line-119"></span><span id="renderSF"><span class="annot"><span class="annottext">renderSF :: forall p a b.
(Clock p, ToMusic1 a, AudioSample b) =&gt;
Music a -&gt; InstrMap (Signal p () b) -&gt; (Double, Signal p () b)
</span><a href="Euterpea.IO.Audio.Render.html#renderSF"><span class="hs-identifier hs-var hs-var">renderSF</span></a></span></span><span> </span><span id="local-6989586621679105678"><span class="annot"><span class="annottext">Music a
</span><a href="#local-6989586621679105678"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621679105679"><span class="annot"><span class="annottext">InstrMap (Signal p () b)
</span><a href="#local-6989586621679105679"><span class="hs-identifier hs-var">im</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span>
</span><span id="line-120"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679105681"><span class="annot"><span class="annottext">[MEvent]
</span><a href="#local-6989586621679105681"><span class="hs-identifier hs-var">pf</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679105682"><span class="annot"><span class="annottext">PTime
</span><a href="#local-6989586621679105682"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Music1 -&gt; ([MEvent], PTime)
</span><a href="Euterpea.IO.MIDI.MEvent.html#perform1Dur"><span class="hs-identifier hs-var">perform1Dur</span></a></span><span> </span><span class="annot"><span class="annottext">(Music1 -&gt; ([MEvent], PTime)) -&gt; Music1 -&gt; ([MEvent], PTime)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Music a -&gt; Music1
forall a. ToMusic1 a =&gt; Music a -&gt; Music1
</span><a href="Euterpea.Music.html#toMusic1"><span class="hs-identifier hs-var">toMusic1</span></a></span><span> </span><span class="annot"><span class="annottext">Music a
</span><a href="#local-6989586621679105678"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-comment">-- Updated 16-Dec-2015 </span><span>
</span><span id="line-121"></span><span>        </span><span id="local-6989586621679105686"><span class="annot"><span class="annottext">evtsf :: Signal p () [Evt (Signal p () b)]
</span><a href="#local-6989586621679105686"><span class="hs-identifier hs-var hs-var">evtsf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[MEvent]
-&gt; InstrMap (Signal p () b) -&gt; Signal p () [Evt (Signal p () b)]
forall p a.
Clock p =&gt;
[MEvent] -&gt; InstrMap a -&gt; Signal p () [Evt a]
</span><a href="Euterpea.IO.Audio.Render.html#toEvtSF"><span class="hs-identifier hs-var">toEvtSF</span></a></span><span> </span><span class="annot"><span class="annottext">[MEvent]
</span><a href="#local-6989586621679105681"><span class="hs-identifier hs-var">pf</span></a></span><span> </span><span class="annot"><span class="annottext">InstrMap (Signal p () b)
</span><a href="#local-6989586621679105679"><span class="hs-identifier hs-var">im</span></a></span><span>
</span><span id="line-122"></span><span>        </span><span id="local-6989586621679105690"><span class="annot"><span class="annottext">allsf :: Signal p () (IntMap b)
</span><a href="#local-6989586621679105690"><span class="hs-identifier hs-var hs-var">allsf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntMap (Signal p () b)
-&gt; Signal p () [Evt (Signal p () b)]
-&gt; (IntMap (Signal p () b)
    -&gt; [Evt (Signal p () b)] -&gt; IntMap (Signal p () b))
-&gt; Signal p () (IntMap b)
forall p (col :: * -&gt; *) a.
(Clock p, Functor col) =&gt;
col (Signal p () a)
-&gt; Signal p () [Evt (Signal p () a)]
-&gt; (col (Signal p () a)
    -&gt; [Evt (Signal p () a)] -&gt; col (Signal p () a))
-&gt; Signal p () (col a)
</span><a href="Euterpea.IO.Audio.Render.html#pSwitch"><span class="hs-identifier hs-var">pSwitch</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (Signal p () b)
forall a. IntMap a
</span><span class="hs-identifier hs-var">M.empty</span></span><span> </span><span class="annot"><span class="annottext">Signal p () [Evt (Signal p () b)]
</span><a href="#local-6989586621679105686"><span class="hs-identifier hs-var">evtsf</span></a></span><span> </span><span class="annot"><span class="annottext">IntMap (Signal p () b)
-&gt; [Evt (Signal p () b)] -&gt; IntMap (Signal p () b)
forall a. IntMap a -&gt; [Evt a] -&gt; IntMap a
</span><a href="Euterpea.IO.Audio.Render.html#modSF"><span class="hs-identifier hs-var">modSF</span></a></span><span>
</span><span id="line-123"></span><span>        </span><span id="local-6989586621679105701"><span class="annot"><span class="annottext">sf :: Signal p () b
</span><a href="#local-6989586621679105701"><span class="hs-identifier hs-var hs-var">sf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Signal p () (IntMap b)
</span><a href="#local-6989586621679105690"><span class="hs-identifier hs-var">allsf</span></a></span><span> </span><span class="annot"><span class="annottext">Signal p () (IntMap b) -&gt; ArrowP SF p (IntMap b) b -&gt; Signal p () b
forall {k} (cat :: k -&gt; k -&gt; *) (a :: k) (b :: k) (c :: k).
Category cat =&gt;
cat a b -&gt; cat b c -&gt; cat a c
</span><span class="hs-operator hs-var">&gt;&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(IntMap b -&gt; b) -&gt; ArrowP SF p (IntMap b) b
forall b c. (b -&gt; c) -&gt; ArrowP SF p b c
forall (a :: * -&gt; * -&gt; *) b c. Arrow a =&gt; (b -&gt; c) -&gt; a b c
</span><span class="hs-identifier hs-var">arr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(b -&gt; b -&gt; b) -&gt; b -&gt; [b] -&gt; b
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; b -&gt; b
forall a. AudioSample a =&gt; a -&gt; a -&gt; a
</span><a href="Euterpea.IO.Audio.Types.html#mix"><span class="hs-identifier hs-var">mix</span></a></span><span> </span><span class="annot"><span class="annottext">b
forall a. AudioSample a =&gt; a
</span><a href="Euterpea.IO.Audio.Types.html#zero"><span class="hs-identifier hs-var">zero</span></a></span><span> </span><span class="annot"><span class="annottext">([b] -&gt; b) -&gt; (IntMap b -&gt; [b]) -&gt; IntMap b -&gt; b
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IntMap b -&gt; [b]
forall a. IntMap a -&gt; [a]
</span><span class="hs-identifier hs-var">M.elems</span></span><span class="hs-special">)</span><span>  </span><span class="hs-comment">-- add up all samples</span><span>
</span><span id="line-124"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PTime -&gt; Double
forall a. Fractional a =&gt; PTime -&gt; a
</span><span class="hs-identifier hs-var">fromRational</span></span><span> </span><span class="annot"><span class="annottext">PTime
</span><a href="#local-6989586621679105682"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Signal p () b
</span><a href="#local-6989586621679105701"><span class="hs-identifier hs-var">sf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-125"></span></pre></body></html>